<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SuperAdmin - Divergent Studio{% endblock %}</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #8e44ad;
            --primary-dark: #7d3c98;
            --sidebar-bg: #1a1a2e;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f6f9;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: #ecf0f1;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(142, 68, 173, 0.2);
        }

        .sidebar-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: #8e44ad;
        }

        .sidebar-badge {
            display: inline-block;
            background: #8e44ad;
            color: white;
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-label {
            padding: 0.5rem 1.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #7f8c8d;
            margin-top: 1rem;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.85rem 1.5rem;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(142, 68, 173, 0.3);
            border-left-color: #8e44ad;
            color: white;
        }

        .menu-item i {
            width: 24px;
            margin-right: 0.75rem;
        }

        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }

        .top-navbar {
            background: white;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .content-area {
            padding: 1.5rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ecf0f1;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
            color: white;
            border: none;
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.bg-purple { background: linear-gradient(135deg, #8e44ad, #7d3c98); }
        .stat-icon.bg-green { background: linear-gradient(135deg, #27ae60, #1e8449); }
        .stat-icon.bg-blue { background: linear-gradient(135deg, #3498db, #2980b9); }
        .stat-icon.bg-orange { background: linear-gradient(135deg, #f39c12, #d68910); }

        .stat-info h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-info p {
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        
        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #7f8c8d;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #ecf0f1;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #8e44ad;
        }
        
        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
            border: none;
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #d5dbdb;
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block !important;
            }
            
            .top-navbar {
                padding: 0.75rem 1rem;
            }
            
            .page-title {
                font-size: 1rem;
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .dashboard-card {
                padding: 1rem;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }
            
            .stat-info h3 {
                font-size: 1.5rem;
            }
            
            /* Tablas responsivas */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .data-table th, .data-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }
        }
        
        @media (max-width: 480px) {
            .content-area {
                padding: 0.75rem;
            }
            
            .dashboard-card {
                padding: 0.875rem;
                border-radius: 10px;
            }
            
            .card-title {
                font-size: 1rem;
            }
            
            .stat-card {
                flex-direction: column;
                text-align: center;
            }
            
            .stat-info h3 {
                font-size: 1.25rem;
            }
            
            /* Tabla formato tarjetas en móvil */
            .data-table thead {
                display: none;
            }
            
            .data-table, .data-table tbody, .data-table tr, .data-table td {
                display: block;
                width: 100%;
            }
            
            .data-table tr {
                margin-bottom: 1rem;
                background: #f8f9fa;
                border-radius: 8px;
                padding: 0.5rem;
            }
            
            .data-table td {
                padding: 0.5rem 0.75rem;
                border-bottom: none;
                text-align: left;
            }
            
            .data-table td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #7f8c8d;
                font-size: 0.7rem;
                text-transform: uppercase;
                display: block;
                margin-bottom: 0.25rem;
            }
            
            .btn-primary {
                width: 100%;
                padding: 0.75rem 1rem;
            }
            
            /* Modal responsivo */
            .modal-content {
                width: 95%;
                margin: 0.5rem;
                border-radius: 12px;
            }
            
            .modal-header {
                padding: 1rem;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .modal-footer {
                padding: 0.75rem 1rem;
                flex-direction: column;
            }
            
            .modal-footer .btn-primary,
            .modal-footer .btn-secondary {
                width: 100%;
            }
            
            .form-input {
                font-size: 16px; /* Evita zoom en iOS */
            }
        }
        
        /* Overlay móvil */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .mobile-overlay.active {
            display: block;
        }
        
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #2c3e50;
            cursor: pointer;
            padding: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Overlay móvil -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-crown"></i> Divergent Studio
            </div>
            <div class="sidebar-badge">SuperAdmin</div>
        </div>
        
        <nav class="sidebar-menu">
            <div class="menu-label">Panel Principal</div>
            <a href="{{ url_for('superadmin_restaurantes') }}" class="menu-item{% if request.endpoint == 'superadmin_restaurantes' %} active{% endif %}">
                <i class="fas fa-store"></i>
                Restaurantes
            </a>
            
            <div class="menu-label">Gestión</div>
            <a href="{{ url_for('superadmin_usuarios') }}" class="menu-item{% if request.endpoint == 'superadmin_usuarios' %} active{% endif %}">
                <i class="fas fa-users"></i>
                Usuarios
            </a>
            <a href="{{ url_for('superadmin_estadisticas') }}" class="menu-item{% if request.endpoint == 'superadmin_estadisticas' %} active{% endif %}">
                <i class="fas fa-chart-bar"></i>
                Estadísticas
            </a>
            <a href="{{ url_for('superadmin_suscripciones') }}" class="menu-item{% if request.endpoint == 'superadmin_suscripciones' %} active{% endif %}">
                <i class="fas fa-credit-card"></i>
                Suscripciones
            </a>
            
            <div class="menu-label">Soporte</div>
            <a href="{{ url_for('superadmin_tickets') }}" class="menu-item{% if request.endpoint == 'superadmin_tickets' %} active{% endif %}">
                <i class="fas fa-headset"></i>
                Tickets
                {% if tickets_pendientes is defined and tickets_pendientes > 0 %}
                <span style="background: #e74c3c; color: white; font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 10px; margin-left: auto;">{{ tickets_pendientes }}</span>
                {% endif %}
            </a>
            
            <div class="menu-label">Sistema</div>
            <a href="#" class="menu-item" onclick="abrirModalPassword(); return false;">
                <i class="fas fa-key"></i>
                Cambiar Contraseña
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-cog"></i>
                Configuración
            </a>
            <a href="{{ url_for('logout') }}" class="menu-item">
                <i class="fas fa-sign-out-alt"></i>
                Cerrar Sesión
            </a>
        </nav>
    </aside>

    <!-- Modal Cambiar Contraseña -->
    <div class="modal" id="modalPassword">
        <div class="modal-background" onclick="cerrarModalPassword()"></div>
        <div class="modal-card" style="max-width: 420px;">
            <header class="modal-card-head" style="background: linear-gradient(135deg, #8e44ad, #7d3c98);">
                <p class="modal-card-title" style="color: white;">
                    <i class="fas fa-key" style="margin-right: 0.5rem;"></i>
                    Cambiar Contraseña
                </p>
                <button class="delete" aria-label="close" onclick="cerrarModalPassword()"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Contraseña actual</label>
                    <div class="control has-icons-left">
                        <input class="input" type="password" id="passwordActual" placeholder="Tu contraseña actual">
                        <span class="icon is-left"><i class="fas fa-lock"></i></span>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Nueva contraseña</label>
                    <div class="control has-icons-left">
                        <input class="input" type="password" id="passwordNuevo" placeholder="Mínimo 8 caracteres">
                        <span class="icon is-left"><i class="fas fa-key"></i></span>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Confirmar nueva contraseña</label>
                    <div class="control has-icons-left">
                        <input class="input" type="password" id="passwordConfirmar" placeholder="Repite la nueva contraseña">
                        <span class="icon is-left"><i class="fas fa-check-double"></i></span>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot" style="justify-content: flex-end;">
                <button class="button" onclick="cerrarModalPassword()">Cancelar</button>
                <button class="button is-primary" id="btnCambiarPassword" onclick="cambiarPassword()" style="background: linear-gradient(135deg, #8e44ad, #7d3c98); border: none;">
                    <i class="fas fa-save" style="margin-right: 0.5rem;"></i>
                    Guardar
                </button>
            </footer>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <header class="top-navbar">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">{% block page_title %}SuperAdmin{% endblock %}</h1>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Notificaciones push -->
                <div style="position: relative;" id="notificationsContainer">
                    <button id="notificationsBtn" style="background: none; border: none; font-size: 1.25rem; color: #7f8c8d; cursor: pointer; position: relative;" title="Notificaciones">
                        <i class="fas fa-bell"></i>
                        <span id="notificationBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; font-size: 0.65rem; padding: 0.1rem 0.4rem; border-radius: 10px; min-width: 16px; text-align: center;">0</span>
                    </button>
                    <div id="notificationsDropdown" style="display: none; position: absolute; right: 0; top: 45px; background: white; border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.15); width: 320px; max-height: 400px; overflow-y: auto; z-index: 1000;">
                        <div style="padding: 1rem; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #2c3e50;"><i class="fas fa-bell"></i> Notificaciones</strong>
                            <button id="clearNotifications" style="background: none; border: none; color: #8e44ad; cursor: pointer; font-size: 0.8rem;">Marcar leídas</button>
                        </div>
                        <div id="notificationsList" style="max-height: 300px; overflow-y: auto;">
                            <div style="padding: 2rem; text-align: center; color: #7f8c8d;">
                                <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                <p>Sin notificaciones nuevas</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <span style="color: #7f8c8d;" class="user-name-text">{{ session.get('nombre', 'Admin') }}</span>
                <div style="width: 40px; height: 40px; background: #8e44ad; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                    {{ session.get('nombre', 'A')[0]|upper }}
                </div>
            </div>
        </header>

        <div class="content-area">
            {% block content %}{% endblock %}
        </div>
    </div>

    <script>
        // Toggle sidebar en móvil
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('mobileOverlay');

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
        }

        if (overlay) {
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }
        
        // Hacer tablas responsivas
        function makeTablesResponsive() {
            document.querySelectorAll('.data-table').forEach(table => {
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                table.querySelectorAll('tbody tr').forEach(row => {
                    row.querySelectorAll('td').forEach((td, i) => {
                        if (headers[i]) td.setAttribute('data-label', headers[i]);
                    });
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', makeTablesResponsive);
        
        // ============================================================
        // SISTEMA DE NOTIFICACIONES EN TIEMPO REAL
        // ============================================================
        (function() {
            const notificationsBtn = document.getElementById('notificationsBtn');
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsList = document.getElementById('notificationsList');
            const clearNotifications = document.getElementById('clearNotifications');
            
            let lastTicketCount = {{ tickets_pendientes|default(0) }};
            let notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
            let notificationSound = null;
            
            // Cargar sonido de notificación
            try {
                notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleWw0NlWcy+aqcRkGVajW5p16WSwkSZXD15OAUCU4SZe/0IWFUx82bYavoJp4V0QyNXmouJaGaE4xMW2jsJiOdVY8MGWep5qSfVtBLlqXop+YhmBIMVSRnaCdj2pUQjhBjZmgnZN0XVJHR3qRmZ2VfGVaTl5vhpSYm4RwYFxjZoCNlZWMf3BlZGl3gpCUkoN5bG9vdYCIjY+MgHl0dHd5f4WKi4d/eXp7e3yAhIiIhYB8fHx8fYCChYaEgH5+fX19f4GCg4OBf35+fn5/gIGCgoGAf3+Af4CAgoKCgYGAgICAgICBgYKBgYGAgYCBgIGBgYGBgYGBgICAgIGBgYGAgYCBgYGAgYCBgYGAgA==');
            } catch(e) {
                console.log('Audio no disponible');
            }
            
            // Toggle dropdown
            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationsDropdown.style.display = 
                        notificationsDropdown.style.display === 'none' ? 'block' : 'none';
                });
            }
            
            // Cerrar al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#notificationsContainer')) {
                    notificationsDropdown.style.display = 'none';
                }
            });
            
            // Limpiar notificaciones
            if (clearNotifications) {
                clearNotifications.addEventListener('click', () => {
                    notifications = [];
                    localStorage.setItem('adminNotifications', '[]');
                    updateNotificationUI();
                });
            }
            
            // Actualizar UI de notificaciones
            function updateNotificationUI() {
                const unreadCount = notifications.filter(n => !n.read).length;
                
                if (unreadCount > 0) {
                    notificationBadge.style.display = 'block';
                    notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                } else {
                    notificationBadge.style.display = 'none';
                }
                
                if (notifications.length === 0) {
                    notificationsList.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: #7f8c8d;">
                            <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <p>Sin notificaciones nuevas</p>
                        </div>
                    `;
                } else {
                    notificationsList.innerHTML = notifications.slice(0, 10).map((n, i) => `
                        <div style="padding: 1rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; ${!n.read ? 'background: #f8f4ff;' : ''}" 
                             onclick="window.location.href='${n.url || '#'}'">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                                <div style="width: 36px; height: 36px; background: ${n.color || '#8e44ad'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                                    <i class="${n.icon || 'fas fa-bell'}"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <p style="font-weight: 500; color: #2c3e50; margin: 0; font-size: 0.9rem;">${n.title}</p>
                                    <p style="color: #7f8c8d; font-size: 0.8rem; margin: 0.25rem 0 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${n.message}</p>
                                    <span style="color: #95a5a6; font-size: 0.7rem;">${formatTime(n.time)}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            // Formatear tiempo
            function formatTime(timestamp) {
                const diff = Date.now() - timestamp;
                const minutes = Math.floor(diff / 60000);
                if (minutes < 1) return 'Ahora';
                if (minutes < 60) return `Hace ${minutes} min`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `Hace ${hours} h`;
                return `Hace ${Math.floor(hours / 24)} días`;
            }
            
            // Agregar notificación
            function addNotification(title, message, icon, color, url) {
                const notification = {
                    id: Date.now(),
                    title,
                    message,
                    icon: icon || 'fas fa-bell',
                    color: color || '#8e44ad',
                    url: url || '',
                    time: Date.now(),
                    read: false
                };
                
                notifications.unshift(notification);
                if (notifications.length > 50) notifications = notifications.slice(0, 50);
                localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                
                updateNotificationUI();
                
                // Sonido
                if (notificationSound) {
                    try { notificationSound.play().catch(() => {}); } catch(e) {}
                }
                
                // Notificación del navegador
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, {
                        body: message,
                        icon: '/static/favicon.ico',
                        tag: 'admin-notification'
                    });
                }
            }
            
            // Solicitar permisos de notificación
            if ('Notification' in window && Notification.permission === 'default') {
                // Mostrar botón para solicitar permisos
                setTimeout(() => {
                    Notification.requestPermission();
                }, 3000);
            }
            
            // Polling para nuevos tickets
            async function checkNewTickets() {
                try {
                    const response = await fetch('/api/superadmin/stats');
                    if (response.ok) {
                        const data = await response.json();
                        const currentPendientes = data.tickets_pendientes || 0;
                        
                        if (currentPendientes > lastTicketCount) {
                            const newTickets = currentPendientes - lastTicketCount;
                            addNotification(
                                `${newTickets} nuevo${newTickets > 1 ? 's' : ''} ticket${newTickets > 1 ? 's' : ''}`,
                                `Tienes ${currentPendientes} ticket${currentPendientes > 1 ? 's' : ''} pendiente${currentPendientes > 1 ? 's' : ''} de revisión`,
                                'fas fa-headset',
                                '#e74c3c',
                                '{{ url_for("superadmin_tickets") }}'
                            );
                        }
                        
                        lastTicketCount = currentPendientes;
                        
                        // Actualizar badge del sidebar también
                        const sidebarBadge = document.querySelector('.menu-item[href*="tickets"] span');
                        if (sidebarBadge) {
                            sidebarBadge.textContent = currentPendientes;
                            sidebarBadge.style.display = currentPendientes > 0 ? 'inline' : 'none';
                        }
                    }
                } catch (e) {
                    console.log('Error checking tickets:', e);
                }
            }
            
            // Inicializar
            updateNotificationUI();
            
            // Polling cada 30 segundos
            setInterval(checkNewTickets, 30000);
            
            // Primera verificación después de 5 segundos
            setTimeout(checkNewTickets, 5000);
            
        })();
    </script>
    
    <!-- Script para cambiar contraseña -->
    <script>
        function abrirModalPassword() {
            document.getElementById('passwordActual').value = '';
            document.getElementById('passwordNuevo').value = '';
            document.getElementById('passwordConfirmar').value = '';
            document.getElementById('modalPassword').classList.add('is-active');
            setTimeout(() => document.getElementById('passwordActual').focus(), 100);
        }
        
        function cerrarModalPassword() {
            document.getElementById('modalPassword').classList.remove('is-active');
        }
        
        async function cambiarPassword() {
            const passwordActual = document.getElementById('passwordActual').value;
            const passwordNuevo = document.getElementById('passwordNuevo').value;
            const passwordConfirmar = document.getElementById('passwordConfirmar').value;
            
            if (!passwordActual || !passwordNuevo || !passwordConfirmar) {
                alert('Por favor completa todos los campos');
                return;
            }
            
            if (passwordNuevo !== passwordConfirmar) {
                alert('Las contraseñas nuevas no coinciden');
                document.getElementById('passwordConfirmar').focus();
                return;
            }
            
            if (passwordNuevo.length < 8) {
                alert('La nueva contraseña debe tener al menos 8 caracteres');
                document.getElementById('passwordNuevo').focus();
                return;
            }
            
            const btn = document.getElementById('btnCambiarPassword');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            try {
                const response = await fetch('/superadmin/cambiar-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password_actual: passwordActual,
                        password_nuevo: passwordNuevo,
                        password_confirmar: passwordConfirmar
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    cerrarModalPassword();
                    
                    // Mostrar mensaje de éxito
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; display: flex; align-items: center; gap: 0.75rem;';
                    successDiv.innerHTML = '<i class="fas fa-check-circle"></i> Contraseña actualizada correctamente';
                    document.body.appendChild(successDiv);
                    
                    setTimeout(() => successDiv.remove(), 4000);
                } else {
                    alert(result.error || 'Error al cambiar la contraseña');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
        
        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('modalPassword').classList.contains('is-active')) {
                cerrarModalPassword();
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
