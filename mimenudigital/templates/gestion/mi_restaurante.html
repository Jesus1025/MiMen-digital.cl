{% extends "gestion/base_gestion.html" %}

{% block title %}Mi Restaurante - {{ restaurante.nombre }}{% endblock %}

{% block page_title %}Mi Restaurante{% endblock %}

{% block content %}
<div class="columns">
    <div class="column is-8">
        <!-- Información del Restaurante -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-store"></i> Información del Restaurante</h2>
            </div>
            
            <form id="formRestaurante">
                <div class="columns">
                    <div class="column is-6">
                        <div class="form-group">
                            <label class="form-label">Nombre del Restaurante *</label>
                            <input type="text" class="form-input" id="nombre" value="{{ restaurante.nombre }}" required>
                        </div>
                    </div>
                    <div class="column is-6">
                        <div class="form-group">
                            <label class="form-label">URL del Menú</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" class="form-input" id="url_slug" value="{{ restaurante.url_slug }}" readonly style="background: #f5f5f5;">
                                <button type="button" class="btn-secondary" onclick="copiarURL()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small style="color: var(--text-muted);">Esta URL no se puede cambiar</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-input" id="descripcion" rows="3" placeholder="Describe tu restaurante...">{{ restaurante.descripcion or '' }}</textarea>
                </div>

                <div class="columns">
                    <div class="column is-6">
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" class="form-input" id="telefono" value="{{ restaurante.telefono or '' }}" placeholder="+56 9 1234 5678">
                        </div>
                    </div>
                    <div class="column is-6">
                        <div class="form-group">
                            <label class="form-label">Email de Contacto</label>
                            <input type="email" class="form-input" id="email" value="{{ restaurante.email or '' }}" placeholder="contacto@turestaurante.com">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Dirección</label>
                    <input type="text" class="form-input" id="direccion" value="{{ restaurante.direccion or '' }}" placeholder="Av. Principal 123, Ciudad">
                </div>

                <div class="form-group">
                    <label class="form-label">Horario de Atención</label>
                    <input type="text" class="form-input" id="horario" value="{{ restaurante.horario or '' }}" placeholder="Lunes a Viernes: 12:00 - 22:00">
                </div>

                <div style="margin-top: 1.5rem;">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="column is-4">
        <!-- Logo del Restaurante -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-image"></i> Logo</h2>
            </div>
            
            <div style="text-align: center;">
                <div id="logoPreview" style="width: 150px; height: 150px; border-radius: 12px; background: #f5f5f5; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    {% if restaurante.logo_url %}
                        <img src="{{ restaurante.logo_url }}" alt="Logo" style="max-width: 100%; max-height: 100%; object-fit: cover;">
                    {% else %}
                        <i class="fas fa-store" style="font-size: 3rem; color: #bdc3c7;"></i>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">URL del Logo</label>
                    <input type="url" class="form-input" id="logo_url" value="{{ restaurante.logo_url or '' }}" placeholder="https://ejemplo.com/logo.png" onchange="actualizarLogoPreview()">
                </div>
                <small style="color: var(--text-muted);">Usa una URL de imagen externa (Imgur, etc.)</small>
            </div>
        </div>

        <!-- Redes Sociales -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-share-alt"></i> Redes Sociales</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label"><i class="fab fa-instagram" style="color: #e4405f;"></i> Instagram</label>
                <input type="text" class="form-input" id="instagram" value="{{ restaurante.instagram or '' }}" placeholder="@turestaurante">
            </div>
            
            <div class="form-group">
                <label class="form-label"><i class="fab fa-facebook" style="color: #1877f2;"></i> Facebook</label>
                <input type="text" class="form-input" id="facebook" value="{{ restaurante.facebook or '' }}" placeholder="facebook.com/turestaurante">
            </div>
            
            <div class="form-group">
                <label class="form-label"><i class="fab fa-whatsapp" style="color: #25d366;"></i> WhatsApp</label>
                <input type="text" class="form-input" id="whatsapp" value="{{ restaurante.whatsapp or '' }}" placeholder="+56912345678">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const BASE_URL = '{{ base_url }}';

function copiarURL() {
    const url = BASE_URL + '/menu/{{ restaurante.url_slug }}';
    navigator.clipboard.writeText(url).then(() => {
        alert('URL copiada: ' + url);
    });
}

function actualizarLogoPreview() {
    const url = document.getElementById('logo_url').value;
    const preview = document.getElementById('logoPreview');
    
    if (url) {
        preview.innerHTML = `<img src="${url}" alt="Logo" style="max-width: 100%; max-height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-exclamation-triangle\\' style=\\'font-size: 2rem; color: #e74c3c;\\'></i>'">`;
    } else {
        preview.innerHTML = '<i class="fas fa-store" style="font-size: 3rem; color: #bdc3c7;"></i>';
    }
}

document.getElementById('formRestaurante').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const data = {
        nombre: document.getElementById('nombre').value,
        descripcion: document.getElementById('descripcion').value,
        telefono: document.getElementById('telefono').value,
        email: document.getElementById('email').value,
        direccion: document.getElementById('direccion').value,
        horario: document.getElementById('horario').value,
        logo_url: document.getElementById('logo_url').value,
        instagram: document.getElementById('instagram').value,
        facebook: document.getElementById('facebook').value,
        whatsapp: document.getElementById('whatsapp').value
    };
    
    try {
        const response = await fetch('/api/mi-restaurante', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('¡Cambios guardados correctamente!');
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error de conexión');
        console.error(error);
    }
});
</script>
{% endblock %}
