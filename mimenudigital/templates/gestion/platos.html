{% extends "gestion/base_gestion.html" %}

{% block title %}Gesti√≥n de Platos - Men√∫ Digital{% endblock %}
{% block page_title %}Gesti√≥n de Platos{% endblock %}

{% block content %}
<style>
    /* ============================================
       ESTILOS MEJORADOS PARA GESTI√ìN DE PLATOS
       ============================================ */
    
    /* Container principal centrado */
    .platos-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
    }
    
    /* Card principal mejorada */
    .platos-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .platos-card-header {
        background: linear-gradient(135deg, #fff 0%, #fafbfc 100%);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #eef2f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .platos-card-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.35rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }
    
    .platos-card-title i {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .platos-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    
    .platos-actions .btn-primary,
    .platos-actions .btn-secondary {
        padding: 0.7rem 1.25rem;
        border-radius: 10px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .platos-actions .btn-primary:hover,
    .platos-actions .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .platos-card-body {
        padding: 1.5rem 2rem 2rem;
    }
    
    /* Filtros mejorados */
    .filtros-container {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    
    .filtro-buscar {
        flex: 1;
        min-width: 200px;
        position: relative;
    }
    
    .filtro-buscar i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #95a5a6;
    }
    
    .filtro-buscar input {
        width: 100%;
        padding: 0.85rem 1rem 0.85rem 2.75rem;
        border: 2px solid #eef2f7;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background: #fafbfc;
    }
    
    .filtro-buscar input:focus {
        outline: none;
        border-color: #e74c3c;
        background: white;
        box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.1);
    }
    
    .filtro-categoria {
        min-width: 180px;
    }
    
    .filtro-categoria select {
        width: 100%;
        padding: 0.85rem 2.5rem 0.85rem 1rem;
        border: 2px solid #eef2f7;
        border-radius: 10px;
        font-size: 0.95rem;
        background: #fafbfc url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2395a5a6' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 1rem center;
        appearance: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .filtro-categoria select:focus {
        outline: none;
        border-color: #e74c3c;
        background-color: white;
        box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.1);
    }
    
    /* Tabla mejorada */
    .platos-table-container {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid #eef2f7;
    }
    
    .platos-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .platos-table thead {
        background: linear-gradient(135deg, #f8f9fa 0%, #eef2f7 100%);
    }
    
    .platos-table th {
        padding: 1rem 1.25rem;
        text-align: left;
        font-weight: 600;
        color: #5a6c7d;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #eef2f7;
    }
    
    .platos-table td {
        padding: 1rem 1.25rem;
        vertical-align: middle;
        border-bottom: 1px solid #f4f6f8;
        color: #2c3e50;
    }
    
    .platos-table tbody tr {
        transition: all 0.2s ease;
    }
    
    .platos-table tbody tr:hover {
        background: #fef9f9;
    }
    
    .platos-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* Imagen del plato en tabla */
    .plato-imagen {
        width: 55px;
        height: 55px;
        border-radius: 10px;
        object-fit: cover;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .plato-imagen-placeholder {
        width: 55px;
        height: 55px;
        border-radius: 10px;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #bdc3c7;
        font-size: 1.25rem;
    }
    
    /* Nombre del plato */
    .plato-nombre {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
    }
    
    /* Categor√≠a badge */
    .plato-categoria {
        display: inline-block;
        background: #eef2f7;
        color: #5a6c7d;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    /* Precio */
    .plato-precio {
        font-weight: 700;
        color: #27ae60;
        font-size: 1rem;
    }
    
    /* Estado badge */
    .plato-estado {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.85rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .plato-estado.activo {
        background: #e8f8f0;
        color: #1e8449;
    }
    
    .plato-estado.inactivo {
        background: #fef0f0;
        color: #c0392b;
    }
    
    /* Botones de acciones */
    .plato-acciones {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-accion {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }
    
    .btn-accion-editar {
        background: #ebf5ff;
        color: #2980b9;
    }
    
    .btn-accion-editar:hover {
        background: #2980b9;
        color: white;
        transform: scale(1.1);
    }
    
    .btn-accion-eliminar {
        background: #fef0f0;
        color: #c0392b;
    }
    
    .btn-accion-eliminar:hover {
        background: #c0392b;
        color: white;
        transform: scale(1.1);
    }
    
    /* Estado vac√≠o */
    .platos-empty {
        text-align: center;
        padding: 4rem 2rem;
        color: #95a5a6;
    }
    
    .platos-empty i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .platos-empty h3 {
        font-size: 1.25rem;
        color: #7f8c8d;
        margin-bottom: 0.5rem;
    }
    
    .platos-empty p {
        font-size: 0.9rem;
    }

    /* Mejoras m√≥viles para gesti√≥n de platos */
    @media (max-width: 768px) {
        .platos-card-header {
            padding: 1.25rem 1rem;
            flex-direction: column;
            align-items: stretch;
        }
        
        .platos-card-title {
            font-size: 1.15rem;
            justify-content: center;
        }
        
        .platos-actions {
            flex-direction: column;
        }
        
        .platos-actions .btn-primary,
        .platos-actions .btn-secondary {
            width: 100%;
            justify-content: center;
        }
        
        .platos-card-body {
            padding: 1rem;
        }
        
        .filtros-container {
            flex-direction: column;
        }
        
        .filtro-buscar,
        .filtro-categoria {
            width: 100%;
        }
        
        /* Convertir tabla a tarjetas en m√≥vil */
        .platos-table thead {
            display: none;
        }
        
        .platos-table tbody tr {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            border: 1px solid #eef2f7;
        }
        
        .platos-table td {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border: none !important;
        }
        
        .platos-table td:before {
            content: attr(data-label);
            font-weight: 600;
            color: #7f8c8d;
            min-width: 85px;
            font-size: 0.8rem;
        }
        
        .platos-table td:first-child {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .platos-table td:first-child:before {
            display: none;
        }
        
        .plato-imagen,
        .plato-imagen-placeholder {
            width: 55px !important;
            height: 55px !important;
        }
        
        .platos-table td:last-child {
            justify-content: flex-end;
            padding-top: 1rem;
            margin-top: 0.5rem;
            border-top: 1px solid #eee !important;
        }
        
        .platos-table td:last-child:before {
            display: none;
        }
        
        .modal-content {
            width: 95%;
            max-width: 95%;
            margin: 0.5rem;
            max-height: 95vh;
        }
        
        .modal-body {
            max-height: 75vh;
            overflow-y: auto;
            padding: 1rem;
        }
        
        #dropZone {
            padding: 1rem !important;
        }
        
        #dropZone p {
            font-size: 0.85rem;
        }
        
        /* Galer√≠a de im√°genes en m√≥vil */
        .imagenes-galeria {
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 0.5rem !important;
        }
        
        .imagen-item {
            height: 80px !important;
        }
    }
    
    @media (max-width: 480px) {
        .card-title {
            font-size: 1.1rem;
        }
        
        .btn-primary, .btn-secondary {
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }
        
        .modal-title {
            font-size: 1.1rem;
        }
        
        .form-label {
            font-size: 0.9rem;
        }
        
        .form-input {
            font-size: 16px; /* Evita zoom en iOS */
        }
        
        .imagenes-galeria {
            grid-template-columns: repeat(2, 1fr) !important;
        }
        
        /* Mejoras para tarjetas de platos en m√≥vil peque√±o */
        .platos-table tbody tr {
            padding: 0.75rem;
            padding-right: 70px; /* Espacio para imagen */
        }
        
        .plato-nombre {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .plato-precio {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .plato-categoria {
            font-size: 0.8rem;
        }
        
        /* Botones de acci√≥n m√°s grandes para touch */
        .btn-accion {
            width: 44px !important;
            height: 44px !important;
            font-size: 1.1rem !important;
        }
        
        .plato-acciones {
            gap: 0.75rem !important;
        }
        
        /* Estado m√°s visible */
        .plato-estado {
            padding: 0.4rem 0.75rem !important;
            font-size: 0.85rem !important;
        }
    }
    
    /* Estilos para galer√≠a de im√°genes m√∫ltiples */
    .imagenes-galeria {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        margin-top: 0.75rem;
    }
    
    .imagen-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        height: 100px;
        background: #f5f5f5;
        border: 2px solid transparent;
        transition: all 0.2s ease;
    }
    
    .imagen-item:hover {
        border-color: #e74c3c;
    }
    
    .imagen-item.principal {
        border-color: #27ae60;
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.3);
    }
    
    .imagen-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .imagen-item .imagen-actions {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .imagen-item:hover .imagen-actions {
        opacity: 1;
    }
    
    .imagen-actions button {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .btn-principal {
        background: #27ae60;
        color: white;
    }
    
    .btn-eliminar {
        background: #e74c3c;
        color: white;
    }
    
    .imagen-badge {
        position: absolute;
        bottom: 4px;
        left: 4px;
        background: #27ae60;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
    }
    
    .add-imagen-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #fef5f5;
        border: 2px dashed #e74c3c;
        cursor: pointer;
        color: #e74c3c;
        transition: all 0.2s ease;
    }
    
    .add-imagen-btn:hover {
        background: #fee;
        border-color: #c0392b;
    }
    
    .add-imagen-btn i {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
    }
    
    .add-imagen-btn span {
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    /* ============================================
       ESTILOS PARA SELECTOR DE ETIQUETAS
       ============================================ */
    .etiquetas-opciones {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }
    
    .etiqueta-btn {
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.7rem;
        border-radius: 20px;
        font-size: 0.8rem;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        opacity: 0.85;
        border: 2px solid transparent;
    }
    
    .etiqueta-btn:hover {
        opacity: 1;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .etiqueta-btn.selected {
        opacity: 1;
        border-color: #2c3e50;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        transform: scale(1.05);
    }
    
    #etiquetasSeleccionadas .etiqueta-selected {
        display: inline-flex;
        align-items: center;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.8rem;
        color: white;
        gap: 0.3rem;
    }
    
    #etiquetasSeleccionadas .etiqueta-selected .remove-tag {
        cursor: pointer;
        font-weight: bold;
        margin-left: 0.2rem;
        opacity: 0.8;
        font-size: 0.9rem;
    }
    
    #etiquetasSeleccionadas .etiqueta-selected .remove-tag:hover {
        opacity: 1;
    }
    
    .etiqueta-btn .delete-etiqueta {
        margin-left: 0.3rem;
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 0.7rem;
    }
    
    .etiqueta-btn:hover .delete-etiqueta {
        opacity: 0.7;
    }
    
    .etiqueta-btn .delete-etiqueta:hover {
        opacity: 1;
    }
    
    /* Color presets */
    .color-preset {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 2px solid transparent;
    }
    
    .color-preset:hover {
        transform: scale(1.15);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .color-preset.selected {
        border-color: #2c3e50;
        transform: scale(1.15);
    }
    
    /* Responsive para etiquetas */
    @media (max-width: 768px) {
        .etiqueta-btn {
            padding: 0.35rem 0.6rem;
            font-size: 0.75rem;
        }
        
        /* Contenedor de etiquetas en m√≥vil */
        .etiquetas-disponibles {
            max-height: 120px;
            overflow-y: auto;
            padding: 0.75rem;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Modal de etiqueta m√°s compacto */
        #modalEtiqueta .modal-content {
            width: 95%;
            max-width: 350px;
        }
        
        /* Color presets m√°s grandes para touch */
        .color-preset {
            width: 36px !important;
            height: 36px !important;
        }
        
        /* Contenedor de presets mejor distribuido */
        #colorPresets {
            gap: 0.5rem !important;
            justify-content: center !important;
        }
    }
    
    @media (max-width: 375px) {
        .etiqueta-btn {
            padding: 0.3rem 0.5rem;
            font-size: 0.7rem;
        }
        
        .color-preset {
            width: 32px !important;
            height: 32px !important;
        }
    }
</style>

<div class="platos-container">
    <div class="platos-card">
        <div class="platos-card-header">
            <h2 class="platos-card-title">
                <i class="fas fa-hamburger"></i>
                Mis Platos
            </h2>
            <div class="platos-actions">
                <button class="btn-secondary" onclick="abrirModalCategoria()">
                    <i class="fas fa-folder-plus"></i> Nueva Categor√≠a
                </button>
                <button class="btn-primary" onclick="abrirModalPlato()">
                    <i class="fas fa-plus"></i> Nuevo Plato
                </button>
            </div>
        </div>

        <div class="platos-card-body">
            <!-- Filtros mejorados -->
            <div class="filtros-container">
                <div class="filtro-buscar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="buscarPlato" placeholder="Buscar plato por nombre...">
                </div>
                <div class="filtro-categoria">
                    <select id="filtroCategoria">
                        <option value="">Todas las categor√≠as</option>
                        {% for cat in categorias %}
                            <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Tabla de Platos mejorada -->
            <div class="platos-table-container">
                <table class="platos-table" id="tablaPlatos">
                    <thead>
                        <tr>
                            <th style="width: 70px;">Imagen</th>
                            <th>Nombre</th>
                            <th>Categor√≠a</th>
                            <th>Precio</th>
                            <th>Estado</th>
                            <th style="width: 100px; text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="platosBody">
                        <tr>
                            <td colspan="6">
                                <div class="platos-empty">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <h3>Cargando platos...</h3>
                                    <p>Por favor espera un momento</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuevo/Editar Plato -->
<div class="modal-overlay" id="modalPlato">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalPlatoTitulo">Nuevo Plato</h3>
            <button class="modal-close" onclick="cerrarModalPlato()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formPlato">
                <input type="hidden" id="platoId">
                
                <div class="form-group">
                    <label class="form-label">Nombre del Plato *</label>
                    <input type="text" class="form-input" id="platoNombre" required placeholder="Ej: Hamburguesa Cl√°sica">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Categor√≠a *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select class="form-input" id="platoCategoria" required style="flex: 1;">
                            <option value="">Seleccionar categor√≠a</option>
                            {% for cat in categorias %}
                                <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn-secondary" onclick="abrirModalCategoria()" style="white-space: nowrap; padding: 0.5rem 0.75rem;" title="Crear nueva categor√≠a">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Precio *</label>
                    <input type="number" class="form-input" id="platoPrecio" required placeholder="0" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-input" id="platoDescripcion" rows="3" placeholder="Describe el plato..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Im√°genes del Plato</label>
                    <small style="color: #7f8c8d; display: block; margin-bottom: 0.5rem;">Puedes agregar m√∫ltiples im√°genes. La primera ser√° la principal.</small>
                    
                    <!-- Galer√≠a de im√°genes -->
                    <div id="imagenesGaleria" class="imagenes-galeria">
                        <!-- Las im√°genes se agregan din√°micamente -->
                        <div class="imagen-item add-imagen-btn" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-plus"></i>
                            <span>Agregar</span>
                        </div>
                    </div>
                    
                    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" onchange="subirImagenes(this)">
                    
                    <!-- Progreso de subida -->
                    <div id="uploadProgress" style="display: none; margin-top: 0.75rem;">
                        <div style="background: #eee; border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="width: 0%; height: 8px; background: linear-gradient(90deg, #e74c3c, #c0392b); transition: width 0.3s;"></div>
                        </div>
                        <p id="uploadStatus" style="font-size: 0.85rem; color: #666; margin-top: 0.25rem; text-align: center;">Subiendo im√°genes...</p>
                    </div>
                    
                    <!-- Campos ocultos con las URLs e IDs de Cloudinary -->
                    <input type="hidden" id="platoImagen">
                    <input type="hidden" id="platoImagenPublicId">
                    <input type="hidden" id="platoImagenesJson">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Etiquetas</label>
                    
                    <!-- Mis Etiquetas (cargadas din√°micamente) -->
                    <div class="etiquetas-container" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <small style="color: #7f8c8d;">üè∑Ô∏è Mis etiquetas:</small>
                            <button type="button" class="btn-secondary" onclick="abrirModalNuevaEtiqueta()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                <i class="fas fa-plus"></i> Nueva etiqueta
                            </button>
                        </div>
                        <div id="misEtiquetas" class="etiquetas-opciones" style="min-height: 40px; background: #fafbfc; padding: 0.75rem; border-radius: 8px; border: 1px solid #ecf0f1;">
                            <span style="color: #95a5a6; font-size: 0.85rem;" id="noEtiquetasMsg">Cargando etiquetas...</span>
                        </div>
                    </div>
                    
                    <!-- Etiquetas Seleccionadas para este plato -->
                    <div style="margin-bottom: 0.5rem;">
                        <small style="color: #7f8c8d;">Etiquetas seleccionadas:</small>
                    </div>
                    <div id="etiquetasSeleccionadas" style="min-height: 40px; padding: 0.75rem; background: #e8f6e8; border-radius: 8px; border: 2px dashed #27ae60; display: flex; flex-wrap: wrap; gap: 0.4rem;">
                        <span style="color: #7f8c8d; font-size: 0.85rem;" id="etiquetasPlaceholder">Click en las etiquetas de arriba para agregarlas...</span>
                    </div>
                    
                    <!-- Campo oculto con las etiquetas -->
                    <input type="hidden" id="platoEtiquetas">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalPlato()">Cancelar</button>
            <button class="btn-primary" onclick="guardarPlato()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>

<!-- Modal Nueva Etiqueta -->
<div class="modal-overlay" id="modalNuevaEtiqueta">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Nueva Etiqueta</h3>
            <button class="modal-close" onclick="cerrarModalNuevaEtiqueta()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formNuevaEtiqueta">
                <div class="form-group">
                    <label class="form-label">Nombre de la etiqueta *</label>
                    <input type="text" class="form-input" id="nuevaEtiquetaNombre" required placeholder="Ej: Vegano, Picante, Del d√≠a..." maxlength="50">
                </div>
                <div class="form-group">
                    <label class="form-label">Color</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="color" id="nuevaEtiquetaColor" value="#e74c3c" style="width: 50px; height: 40px; border: none; cursor: pointer; border-radius: 6px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                            <span class="color-preset" data-color="#e74c3c" style="background: #e74c3c; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;"></span>
                            <span class="color-preset" data-color="#27ae60" style="background: #27ae60; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;"></span>
                            <span class="color-preset" data-color="#3498db" style="background: #3498db; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;"></span>
                            <span class="color-preset" data-color="#9b59b6" style="background: #9b59b6; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;"></span>
                            <span class="color-preset" data-color="#f39c12" style="background: #f39c12; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;"></span>
                            <span class="color-preset" data-color="#1abc9c" style="background: #1abc9c; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;"></span>
                            <span class="color-preset" data-color="#e91e63" style="background: #e91e63; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;"></span>
                            <span class="color-preset" data-color="#795548" style="background: #795548; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Emoji (opcional)</label>
                    <input type="text" class="form-input" id="nuevaEtiquetaEmoji" placeholder="Ej: üå± üî• ‚≠ê" maxlength="10">
                    <small style="color: #7f8c8d;">Puedes copiar y pegar un emoji</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Vista previa:</label>
                    <div style="padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                        <span id="previewEtiqueta" style="display: inline-block; padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.85rem; color: white; background: #e74c3c;">
                            Nueva etiqueta
                        </span>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalNuevaEtiqueta()">Cancelar</button>
            <button class="btn-primary" onclick="guardarNuevaEtiqueta()">
                <i class="fas fa-save"></i> Crear Etiqueta
            </button>
        </div>
    </div>
</div>

<!-- Modal Nueva Categor√≠a -->
<div class="modal-overlay" id="modalCategoria">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Nueva Categor√≠a</h3>
            <button class="modal-close" onclick="cerrarModalCategoria()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formCategoria">
                <div class="form-group">
                    <label class="form-label">Nombre de la Categor√≠a *</label>
                    <input type="text" class="form-input" id="categoriaNombre" required placeholder="Ej: Entrantes, Carnes, Bebidas">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalCategoria()">Cancelar</button>
            <button class="btn-primary" onclick="guardarCategoria()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let platos = [];
    let categorias = {{ categorias | default([]) | tojson }};
    let imagenesPlato = []; // Array para manejar m√∫ltiples im√°genes

    document.addEventListener('DOMContentLoaded', function() {
        cargarPlatos();
        
        // B√∫squeda en tiempo real
        document.getElementById('buscarPlato').addEventListener('input', filtrarPlatos);
        document.getElementById('filtroCategoria').addEventListener('change', filtrarPlatos);
        
        // Configurar drag & drop para la galer√≠a
        setupDragDrop();
    });

    async function cargarPlatos() {
        try {
            const res = await fetch('/api/platos');
            platos = await res.json();
            renderizarPlatos(platos);
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error al cargar los platos');
        }
    }

    function renderizarPlatos(lista) {
        const tbody = document.getElementById('platosBody');
        
        if (lista.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="platos-empty">
                            <i class="fas fa-utensils"></i>
                            <h3>No hay platos registrados</h3>
                            <p>Comienza agregando tu primer plato al menu</p>
                            <button class="btn-primary" style="margin-top: 1rem;" onclick="abrirModalPlato()">
                                <i class="fas fa-plus"></i> Agregar primer plato
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = lista.map(plato => {
            const categoria = categorias.find(c => c.id === plato.categoria_id);
            // Obtener la imagen principal (primera del array o imagen_src)
            const imagenPrincipal = plato.imagenes && plato.imagenes.length > 0 
                ? plato.imagenes.find(i => i.es_principal) || plato.imagenes[0]
                : null;
            const imgSrc = imagenPrincipal ? imagenPrincipal.imagen_url : (plato.imagen_src || plato.imagen_url);
            const cantImagenes = plato.imagenes ? plato.imagenes.length : (plato.imagen_url ? 1 : 0);
            
            return `
                <tr>
                    <td data-label="">
                        ${imgSrc 
                            ? `<div style="position: relative; display: inline-block;">
                                <img src="${imgSrc}" alt="${plato.nombre}" class="plato-imagen">
                                ${cantImagenes > 1 ? `<span style="position: absolute; bottom: -4px; right: -4px; background: #3498db; color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; font-weight: 600;">+${cantImagenes-1}</span>` : ''}
                               </div>`
                            : `<div class="plato-imagen-placeholder"><i class="fas fa-image"></i></div>`
                        }
                    </td>
                    <td data-label="Nombre">
                        <span class="plato-nombre">${plato.nombre}</span>
                        ${plato.descripcion ? `<br><small style="color: #7f8c8d; font-size: 0.8rem;">${plato.descripcion.substring(0, 50)}${plato.descripcion.length > 50 ? '...' : ''}</small>` : ''}
                    </td>
                    <td data-label="Categoria"><span class="plato-categoria">${categoria ? categoria.nombre : '-'}</span></td>
                    <td data-label="Precio"><span class="plato-precio">$${Number(plato.precio).toLocaleString('es-CL')}</span></td>
                    <td data-label="Estado">
                        <span class="plato-estado ${plato.activo ? 'activo' : 'inactivo'}" style="cursor: pointer;" onclick="toggleEstado(${plato.id}, ${plato.activo})">
                            <i class="fas fa-${plato.activo ? 'check-circle' : 'pause-circle'}"></i>
                            ${plato.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td data-label="">
                        <div class="plato-acciones">
                            <button class="btn-accion btn-accion-editar" onclick="editarPlato(${plato.id})" title="Editar plato">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-accion btn-accion-eliminar" onclick="eliminarPlato(${plato.id})" title="Eliminar plato">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filtrarPlatos() {
        const busqueda = document.getElementById('buscarPlato').value.toLowerCase();
        const categoriaId = document.getElementById('filtroCategoria').value;
        
        let filtrados = platos;
        
        if (busqueda) {
            filtrados = filtrados.filter(p => 
                p.nombre.toLowerCase().includes(busqueda) ||
                (p.descripcion && p.descripcion.toLowerCase().includes(busqueda))
            );
        }
        
        if (categoriaId) {
            filtrados = filtrados.filter(p => p.categoria_id == categoriaId);
        }
        
        renderizarPlatos(filtrados);
    }

    // Modal Plato
    function abrirModalPlato() {
        document.getElementById('modalPlatoTitulo').textContent = 'Nuevo Plato';
        document.getElementById('formPlato').reset();
        document.getElementById('platoId').value = '';
        document.getElementById('platoImagen').value = '';
        document.getElementById('platoImagenPublicId').value = '';
        imagenesPlato = [];
        renderizarGaleria();
        limpiarEtiquetas(); // Limpiar etiquetas seleccionadas
        document.getElementById('modalPlato').classList.add('active');
    }

    function cerrarModalPlato() {
        document.getElementById('modalPlato').classList.remove('active');
    }

    function editarPlato(id) {
        const plato = platos.find(p => p.id === id);
        if (!plato) return;
        
        document.getElementById('modalPlatoTitulo').textContent = 'Editar Plato';
        document.getElementById('platoId').value = plato.id;
        document.getElementById('platoNombre').value = plato.nombre;
        document.getElementById('platoCategoria').value = plato.categoria_id;
        document.getElementById('platoPrecio').value = plato.precio;
        document.getElementById('platoDescripcion').value = plato.descripcion || '';
        document.getElementById('platoEtiquetas').value = plato.etiquetas || '';
        
        // Cargar etiquetas del plato
        cargarEtiquetasPlato(plato.etiquetas || '');
        
        // Cargar im√°genes del plato
        if (plato.imagenes && plato.imagenes.length > 0) {
            imagenesPlato = plato.imagenes.map(img => ({
                url: img.imagen_url,
                public_id: img.imagen_public_id,
                id: img.id,
                es_principal: img.es_principal
            }));
        } else if (plato.imagen_url) {
            // Compatibilidad con imagen √∫nica antigua
            imagenesPlato = [{
                url: plato.imagen_url,
                public_id: plato.imagen_public_id,
                es_principal: true
            }];
        } else {
            imagenesPlato = [];
        }
        
        // Mantener compatibilidad con campo oculto para imagen principal
        const imgPrincipal = imagenesPlato.find(i => i.es_principal) || imagenesPlato[0];
        if (imgPrincipal) {
            document.getElementById('platoImagen').value = imgPrincipal.url;
            document.getElementById('platoImagenPublicId').value = imgPrincipal.public_id || '';
        }
        
        renderizarGaleria();
        document.getElementById('modalPlato').classList.add('active');
    }

    function renderizarGaleria() {
        const galeria = document.getElementById('imagenesGaleria');
        
        let html = imagenesPlato.map((img, index) => `
            <div class="imagen-item ${img.es_principal ? 'principal' : ''}" data-index="${index}">
                <img src="${img.url}" alt="Imagen ${index + 1}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>Error</text></svg>'">
                ${img.es_principal ? '<span class="imagen-badge">Principal</span>' : ''}
                <div class="imagen-actions">
                    ${!img.es_principal ? `<button type="button" class="btn-principal" onclick="hacerPrincipal(${index})" title="Hacer principal"><i class="fas fa-star"></i></button>` : ''}
                    <button type="button" class="btn-eliminar" onclick="eliminarImagenGaleria(${index})" title="Eliminar"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
        
        // Bot√≥n para agregar m√°s (m√°ximo 5 im√°genes)
        if (imagenesPlato.length < 5) {
            html += `
                <div class="imagen-item add-imagen-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-plus"></i>
                    <span>Agregar</span>
                </div>
            `;
        }
        
        galeria.innerHTML = html;
    }

    function hacerPrincipal(index) {
        imagenesPlato.forEach((img, i) => {
            img.es_principal = (i === index);
        });
        
        // Actualizar campos ocultos con la nueva imagen principal
        const imgPrincipal = imagenesPlato[index];
        document.getElementById('platoImagen').value = imgPrincipal.url;
        document.getElementById('platoImagenPublicId').value = imgPrincipal.public_id || '';
        
        renderizarGaleria();
    }

    function eliminarImagenGaleria(index) {
        const eliminada = imagenesPlato.splice(index, 1)[0];
        
        // Si era la principal, hacer principal a la primera
        if (eliminada.es_principal && imagenesPlato.length > 0) {
            imagenesPlato[0].es_principal = true;
            document.getElementById('platoImagen').value = imagenesPlato[0].url;
            document.getElementById('platoImagenPublicId').value = imagenesPlato[0].public_id || '';
        }
        
        if (imagenesPlato.length === 0) {
            document.getElementById('platoImagen').value = '';
            document.getElementById('platoImagenPublicId').value = '';
        }
        
        renderizarGaleria();
    }

    async function guardarPlato() {
        const id = document.getElementById('platoId').value;
        
        // Preparar im√°genes para enviar
        const imagenes = imagenesPlato.map((img, index) => ({
            imagen_url: img.url,
            imagen_public_id: img.public_id,
            es_principal: img.es_principal ? 1 : 0,
            orden: index
        }));
        
        // Imagen principal para compatibilidad
        const imgPrincipal = imagenesPlato.find(i => i.es_principal) || imagenesPlato[0];
        
        const data = {
            nombre: document.getElementById('platoNombre').value,
            categoria_id: parseInt(document.getElementById('platoCategoria').value),
            precio: parseFloat(document.getElementById('platoPrecio').value),
            descripcion: document.getElementById('platoDescripcion').value,
            imagen_url: imgPrincipal ? imgPrincipal.url : '',
            imagen_public_id: imgPrincipal ? imgPrincipal.public_id : null,
            imagenes: imagenes,
            etiquetas: document.getElementById('platoEtiquetas').value
        };

        if (!data.nombre || !data.categoria_id || !data.precio) {
            alert('Por favor completa los campos obligatorios');
            return;
        }

        try {
            const url = id ? `/api/platos/${id}` : '/api/platos';
            const method = id ? 'PUT' : 'POST';
            
            const res = await fetchWithCSRF(url, {
                method: method,
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            
            if (result.success) {
                cerrarModalPlato();
                cargarPlatos();
                mostrarExito(id ? 'Plato actualizado' : 'Plato creado');
            } else {
                alert(result.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi√≥n');
        }
    }

    async function eliminarPlato(id) {
        if (!confirm('¬øEst√°s seguro de eliminar este plato?')) return;
        
        try {
            const res = await fetchWithCSRF(`/api/platos/${id}`, { method: 'DELETE' });
            const result = await res.json();
            
            if (result.success) {
                cargarPlatos();
                mostrarExito('Plato eliminado');
            } else {
                alert(result.error || 'Error al eliminar');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function toggleEstado(id, estadoActual) {
        const plato = platos.find(p => p.id === id);
        if (!plato) return;
        
        const data = {
            ...plato,
            activo: estadoActual ? 0 : 1
        };
        
        try {
            const res = await fetchWithCSRF(`/api/platos/${id}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                cargarPlatos();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Modal Categor√≠a
    function abrirModalCategoria() {
        document.getElementById('formCategoria').reset();
        document.getElementById('modalCategoria').classList.add('active');
        setTimeout(() => document.getElementById('categoriaNombre').focus(), 100);
    }

    function cerrarModalCategoria() {
        document.getElementById('modalCategoria').classList.remove('active');
    }

    async function guardarCategoria() {
        const nombre = document.getElementById('categoriaNombre').value.trim();
        
        if (!nombre) {
            alert('Por favor ingresa un nombre');
            return;
        }

        try {
            const res = await fetchWithCSRF('/api/categorias', {
                method: 'POST',
                body: JSON.stringify({ nombre: nombre })
            });
            
            const result = await res.json();
            
            if (result.success) {
                // Agregar la nueva categor√≠a al array local
                const nuevaCategoria = {
                    id: result.id,
                    nombre: nombre,
                    activo: true
                };
                categorias.push(nuevaCategoria);
                
                // Actualizar el select de categor√≠as din√°micamente
                const selectCategoria = document.getElementById('platoCategoria');
                const filtroCategoria = document.getElementById('filtroCategoria');
                
                // Agregar opci√≥n al select del formulario
                const nuevaOpcion = document.createElement('option');
                nuevaOpcion.value = result.id;
                nuevaOpcion.textContent = nombre;
                selectCategoria.appendChild(nuevaOpcion);
                
                // Seleccionar autom√°ticamente la nueva categor√≠a
                selectCategoria.value = result.id;
                
                // Tambi√©n agregar al filtro si existe
                if (filtroCategoria) {
                    const opcionFiltro = document.createElement('option');
                    opcionFiltro.value = result.id;
                    opcionFiltro.textContent = nombre;
                    filtroCategoria.appendChild(opcionFiltro);
                }
                
                cerrarModalCategoria();
                mostrarExito(`Categor√≠a "${nombre}" creada correctamente`);
            } else {
                alert(result.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi√≥n');
        }
    }

    // Notificaciones
    function mostrarExito(mensaje) {
        const notif = document.createElement('div');
        notif.className = 'notification is-success';
        notif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease;';
        notif.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i> ${mensaje}
        `;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
    }

    function mostrarError(mensaje) {
        const notif = document.createElement('div');
        notif.className = 'notification is-danger';
        notif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease;';
        notif.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i> ${mensaje}
        `;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 4000);
    }

    // ========================================
    // FUNCIONES DE SUBIDA DE IM√ÅGENES M√öLTIPLES
    // ========================================
    
    async function subirImagenes(input) {
        const files = Array.from(input.files);
        if (files.length === 0) return;
        
        // Verificar l√≠mite de im√°genes
        if (imagenesPlato.length + files.length > 5) {
            mostrarError('M√°ximo 5 im√°genes por plato');
            return;
        }
        
        const progressDiv = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const uploadStatus = document.getElementById('uploadStatus');
        
        progressDiv.style.display = 'block';
        let subidas = 0;
        
        for (const file of files) {
            // Validar tama√±o (5MB)
            if (file.size > 5 * 1024 * 1024) {
                mostrarError(`${file.name} es muy grande. M√°ximo 5MB.`);
                continue;
            }
            
            // Validar tipo
            const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                mostrarError(`${file.name}: tipo no permitido.`);
                continue;
            }
            
            progressBar.style.width = `${(subidas / files.length) * 100}%`;
            uploadStatus.textContent = `Subiendo ${subidas + 1} de ${files.length}...`;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.csrfToken },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const esPrimera = imagenesPlato.length === 0;
                    imagenesPlato.push({
                        url: result.url,
                        public_id: result.public_id,
                        es_principal: esPrimera
                    });
                    
                    // Actualizar campos ocultos con la primera imagen
                    if (esPrimera) {
                        document.getElementById('platoImagen').value = result.url;
                        document.getElementById('platoImagenPublicId').value = result.public_id || '';
                    }
                    
                    subidas++;
                } else {
                    mostrarError(result.error || `Error subiendo ${file.name}`);
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError(`Error de conexi√≥n subiendo ${file.name}`);
            }
        }
        
        progressBar.style.width = '100%';
        uploadStatus.textContent = `${subidas} imagen(es) subida(s)`;
        
        setTimeout(() => {
            progressDiv.style.display = 'none';
            progressBar.style.width = '0%';
        }, 1000);
        
        renderizarGaleria();
        input.value = ''; // Limpiar input
        
        if (subidas > 0) {
            mostrarExito(`${subidas} imagen(es) subida(s) correctamente`);
        }
    }
    
    // ============================================
    // FUNCIONES PARA MANEJO DE ETIQUETAS PERSONALIZADAS
    // ============================================
    let etiquetasSeleccionadas = [];
    let misEtiquetas = []; // Etiquetas del restaurante cargadas de la BD
    
    // Cargar etiquetas del restaurante al iniciar
    async function cargarMisEtiquetas() {
        try {
            const res = await fetch('/api/etiquetas');
            misEtiquetas = await res.json();
            renderizarMisEtiquetas();
        } catch (error) {
            console.error('Error cargando etiquetas:', error);
            document.getElementById('noEtiquetasMsg').textContent = 'Error al cargar etiquetas';
        }
    }
    
    function renderizarMisEtiquetas() {
        const container = document.getElementById('misEtiquetas');
        
        if (misEtiquetas.length === 0) {
            container.innerHTML = '<span style="color: #95a5a6; font-size: 0.85rem;" id="noEtiquetasMsg">No tienes etiquetas creadas. ¬°Crea tu primera etiqueta!</span>';
            return;
        }
        
        container.innerHTML = misEtiquetas.map(etiq => {
            const isSelected = etiquetasSeleccionadas.includes(etiq.nombre);
            return `
                <span class="etiqueta-btn ${isSelected ? 'selected' : ''}" 
                      data-tag="${etiq.nombre}" 
                      data-id="${etiq.id}"
                      data-color="${etiq.color}"
                      onclick="toggleEtiqueta('${etiq.nombre}')" 
                      style="background: ${etiq.color};">
                    ${etiq.emoji ? etiq.emoji + ' ' : ''}${etiq.nombre}
                    <span class="delete-etiqueta" onclick="event.stopPropagation(); eliminarEtiquetaRestaurante(${etiq.id})" title="Eliminar etiqueta">√ó</span>
                </span>
            `;
        }).join('');
    }
    
    function toggleEtiqueta(tagNombre) {
        const index = etiquetasSeleccionadas.indexOf(tagNombre);
        
        if (index === -1) {
            // Agregar
            etiquetasSeleccionadas.push(tagNombre);
        } else {
            // Quitar
            etiquetasSeleccionadas.splice(index, 1);
        }
        
        renderizarMisEtiquetas();
        actualizarEtiquetasUI();
    }
    
    function quitarEtiqueta(tag) {
        const index = etiquetasSeleccionadas.indexOf(tag);
        if (index !== -1) {
            etiquetasSeleccionadas.splice(index, 1);
            renderizarMisEtiquetas();
            actualizarEtiquetasUI();
        }
    }
    
    function actualizarEtiquetasUI() {
        const container = document.getElementById('etiquetasSeleccionadas');
        const hiddenInput = document.getElementById('platoEtiquetas');
        const placeholder = document.getElementById('etiquetasPlaceholder');
        
        if (etiquetasSeleccionadas.length === 0) {
            container.innerHTML = '<span style="color: #7f8c8d; font-size: 0.85rem;" id="etiquetasPlaceholder">Click en las etiquetas de arriba para agregarlas...</span>';
        } else {
            container.innerHTML = etiquetasSeleccionadas.map(tagNombre => {
                // Buscar la etiqueta para obtener su color
                const etiq = misEtiquetas.find(e => e.nombre === tagNombre);
                const color = etiq ? etiq.color : '#34495e';
                const emoji = etiq && etiq.emoji ? etiq.emoji + ' ' : '';
                
                return `<span class="etiqueta-selected" data-tag="${tagNombre}" style="background: ${color};">
                    ${emoji}${tagNombre}
                    <span class="remove-tag" onclick="quitarEtiqueta('${tagNombre}')">&times;</span>
                </span>`;
            }).join(' ');
        }
        
        // Actualizar input oculto
        hiddenInput.value = etiquetasSeleccionadas.join(',');
    }
    
    function cargarEtiquetasPlato(etiquetasStr) {
        etiquetasSeleccionadas = [];
        
        if (etiquetasStr && etiquetasStr.trim()) {
            const etiquetas = etiquetasStr.split(',').map(e => e.trim()).filter(e => e);
            etiquetasSeleccionadas = etiquetas;
        }
        
        renderizarMisEtiquetas();
        actualizarEtiquetasUI();
    }
    
    function limpiarEtiquetas() {
        etiquetasSeleccionadas = [];
        renderizarMisEtiquetas();
        actualizarEtiquetasUI();
    }
    
    // ============================================
    // MODAL NUEVA ETIQUETA
    // ============================================
    function abrirModalNuevaEtiqueta() {
        document.getElementById('nuevaEtiquetaNombre').value = '';
        document.getElementById('nuevaEtiquetaColor').value = '#e74c3c';
        document.getElementById('nuevaEtiquetaEmoji').value = '';
        actualizarPreviewEtiqueta();
        document.getElementById('modalNuevaEtiqueta').classList.add('active');
        
        // Setup color presets
        document.querySelectorAll('.color-preset').forEach(preset => {
            preset.onclick = function() {
                document.getElementById('nuevaEtiquetaColor').value = this.dataset.color;
                document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
                this.classList.add('selected');
                actualizarPreviewEtiqueta();
            };
        });
        
        // Setup preview updates
        document.getElementById('nuevaEtiquetaNombre').addEventListener('input', actualizarPreviewEtiqueta);
        document.getElementById('nuevaEtiquetaColor').addEventListener('input', actualizarPreviewEtiqueta);
        document.getElementById('nuevaEtiquetaEmoji').addEventListener('input', actualizarPreviewEtiqueta);
    }
    
    function cerrarModalNuevaEtiqueta() {
        document.getElementById('modalNuevaEtiqueta').classList.remove('active');
    }
    
    function actualizarPreviewEtiqueta() {
        const nombre = document.getElementById('nuevaEtiquetaNombre').value || 'Nueva etiqueta';
        const color = document.getElementById('nuevaEtiquetaColor').value;
        const emoji = document.getElementById('nuevaEtiquetaEmoji').value;
        
        const preview = document.getElementById('previewEtiqueta');
        preview.style.background = color;
        preview.textContent = (emoji ? emoji + ' ' : '') + nombre;
    }
    
    async function guardarNuevaEtiqueta() {
        const nombre = document.getElementById('nuevaEtiquetaNombre').value.trim();
        const color = document.getElementById('nuevaEtiquetaColor').value;
        const emoji = document.getElementById('nuevaEtiquetaEmoji').value.trim();
        
        if (!nombre) {
            alert('El nombre es requerido');
            return;
        }
        
        try {
            const res = await fetchWithCSRF('/api/etiquetas', {
                method: 'POST',
                body: JSON.stringify({ nombre, color, emoji })
            });
            
            const result = await res.json();
            
            if (result.success) {
                cerrarModalNuevaEtiqueta();
                // Agregar la nueva etiqueta a la lista
                misEtiquetas.push(result.etiqueta);
                renderizarMisEtiquetas();
                mostrarExito('Etiqueta creada correctamente');
            } else {
                alert(result.error || 'Error al crear etiqueta');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi√≥n');
        }
    }
    
    async function eliminarEtiquetaRestaurante(id) {
        if (!confirm('¬øEliminar esta etiqueta? Se quitar√° de todos los platos que la usen.')) return;
        
        try {
            const res = await fetchWithCSRF(`/api/etiquetas/${id}`, {
                method: 'DELETE'
            });
            
            const result = await res.json();
            
            if (result.success) {
                // Quitar de la lista local
                const etiq = misEtiquetas.find(e => e.id === id);
                if (etiq) {
                    // Quitar de seleccionadas si estaba
                    const idx = etiquetasSeleccionadas.indexOf(etiq.nombre);
                    if (idx !== -1) etiquetasSeleccionadas.splice(idx, 1);
                }
                
                misEtiquetas = misEtiquetas.filter(e => e.id !== id);
                renderizarMisEtiquetas();
                actualizarEtiquetasUI();
                mostrarExito('Etiqueta eliminada');
            } else {
                alert(result.error || 'Error al eliminar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi√≥n');
        }
    }
    
    // Cargar etiquetas al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        cargarMisEtiquetas();
    });
    
    function setupDragDrop() {
        const galeria = document.getElementById('imagenesGaleria');
        if (!galeria) return;
        
        galeria.addEventListener('dragover', (e) => {
            e.preventDefault();
            galeria.style.background = '#f0f8ff';
        });
        
        galeria.addEventListener('dragleave', (e) => {
            e.preventDefault();
            galeria.style.background = '';
        });
        
        galeria.addEventListener('drop', (e) => {
            e.preventDefault();
            galeria.style.background = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                subirImagenes(document.getElementById('fileInput'));
            }
        });
    }
</script>

<style>
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
{% endblock %}
