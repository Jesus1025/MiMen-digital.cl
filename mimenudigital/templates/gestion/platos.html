{% extends "gestion/base_gestion.html" %}

{% block title %}Gesti√≥n de Platos - Men√∫ Digital{% endblock %}
{% block page_title %}Gesti√≥n de Platos{% endblock %}

{% block content %}
<style>
    /* Mejoras m√≥viles para gesti√≥n de platos */
    @media (max-width: 768px) {
        .card-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch !important;
        }
        
        .card-header > div {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .card-header .btn-primary,
        .card-header .btn-secondary {
            width: 100%;
            justify-content: center;
        }
        
        .field.is-grouped {
            flex-direction: column;
        }
        
        .field.is-grouped .control {
            margin-bottom: 0.5rem;
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Convertir tabla a tarjetas en m√≥vil */
        .data-table thead {
            display: none;
        }
        
        .data-table tbody tr {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
        }
        
        .data-table tbody td {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border: none !important;
        }
        
        .data-table tbody td:before {
            content: attr(data-label);
            font-weight: 600;
            color: #7f8c8d;
            min-width: 80px;
            font-size: 0.85rem;
        }
        
        .data-table tbody td:first-child {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .data-table tbody td:first-child:before {
            display: none;
        }
        
        .data-table tbody td:first-child img,
        .data-table tbody td:first-child > div {
            width: 60px !important;
            height: 60px !important;
        }
        
        .data-table tbody td:last-child {
            justify-content: flex-end;
            padding-top: 1rem;
            margin-top: 0.5rem;
            border-top: 1px solid #eee !important;
        }
        
        .data-table tbody td:last-child:before {
            display: none;
        }
        
        .modal-content {
            width: 95%;
            max-width: 95%;
            margin: 0.5rem;
            max-height: 95vh;
        }
        
        .modal-body {
            max-height: 75vh;
            overflow-y: auto;
            padding: 1rem;
        }
        
        #dropZone {
            padding: 1rem !important;
        }
        
        #dropZone p {
            font-size: 0.85rem;
        }
        
        /* Galer√≠a de im√°genes en m√≥vil */
        .imagenes-galeria {
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 0.5rem !important;
        }
        
        .imagen-item {
            height: 80px !important;
        }
    }
    
    @media (max-width: 480px) {
        .card-title {
            font-size: 1.1rem;
        }
        
        .btn-primary, .btn-secondary {
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }
        
        .modal-title {
            font-size: 1.1rem;
        }
        
        .form-label {
            font-size: 0.9rem;
        }
        
        .form-input {
            font-size: 16px; /* Evita zoom en iOS */
        }
        
        .imagenes-galeria {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
    
    /* Estilos para galer√≠a de im√°genes m√∫ltiples */
    .imagenes-galeria {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        margin-top: 0.75rem;
    }
    
    .imagen-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        height: 100px;
        background: #f5f5f5;
        border: 2px solid transparent;
        transition: all 0.2s ease;
    }
    
    .imagen-item:hover {
        border-color: #e74c3c;
    }
    
    .imagen-item.principal {
        border-color: #27ae60;
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.3);
    }
    
    .imagen-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .imagen-item .imagen-actions {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .imagen-item:hover .imagen-actions {
        opacity: 1;
    }
    
    .imagen-actions button {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .btn-principal {
        background: #27ae60;
        color: white;
    }
    
    .btn-eliminar {
        background: #e74c3c;
        color: white;
    }
    
    .imagen-badge {
        position: absolute;
        bottom: 4px;
        left: 4px;
        background: #27ae60;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
    }
    
    .add-imagen-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #fef5f5;
        border: 2px dashed #e74c3c;
        cursor: pointer;
        color: #e74c3c;
        transition: all 0.2s ease;
    }
    
    .add-imagen-btn:hover {
        background: #fee;
        border-color: #c0392b;
    }
    
    .add-imagen-btn i {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
    }
    
    .add-imagen-btn span {
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    /* ============================================
       ESTILOS PARA SELECTOR DE ETIQUETAS
       ============================================ */
    .etiquetas-standard {
        background: #fafbfc;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #ecf0f1;
    }
    
    .etiqueta-grupo {
        margin-bottom: 0.75rem;
    }
    
    .etiquetas-opciones {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }
    
    .etiqueta-btn {
        display: inline-flex;
        align-items: center;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.75rem;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        opacity: 0.7;
        border: 2px solid transparent;
    }
    
    .etiqueta-btn:hover {
        opacity: 1;
        transform: scale(1.05);
    }
    
    .etiqueta-btn.selected {
        opacity: 1;
        border-color: #2c3e50;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    #etiquetasSeleccionadas .etiqueta-selected {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        color: white;
        gap: 0.3rem;
    }
    
    #etiquetasSeleccionadas .etiqueta-selected .remove-tag {
        cursor: pointer;
        font-weight: bold;
        margin-left: 0.2rem;
        opacity: 0.8;
    }
    
    #etiquetasSeleccionadas .etiqueta-selected .remove-tag:hover {
        opacity: 1;
    }
    
    /* COLORES DE ETIQUETAS EST√ÅNDAR */
    /* Popularidad */
    .etiqueta-btn[data-tag="nuevo"], .etiqueta-selected[data-tag="nuevo"] { background: #9b59b6; }
    .etiqueta-btn[data-tag="popular"], .etiqueta-selected[data-tag="popular"] { background: #e74c3c; }
    .etiqueta-btn[data-tag="recomendado"], .etiqueta-selected[data-tag="recomendado"] { background: #f39c12; }
    .etiqueta-btn[data-tag="oferta"], .etiqueta-selected[data-tag="oferta"] { background: #e91e63; }
    .etiqueta-btn[data-tag="destacado"], .etiqueta-selected[data-tag="destacado"] { background: #ff5722; }
    
    /* Dieta */
    .etiqueta-btn[data-tag="vegano"], .etiqueta-selected[data-tag="vegano"] { background: #27ae60; }
    .etiqueta-btn[data-tag="vegetariano"], .etiqueta-selected[data-tag="vegetariano"] { background: #2ecc71; }
    .etiqueta-btn[data-tag="sin-gluten"], .etiqueta-selected[data-tag="sin-gluten"] { background: #8e44ad; }
    .etiqueta-btn[data-tag="sin-lactosa"], .etiqueta-selected[data-tag="sin-lactosa"] { background: #3498db; }
    .etiqueta-btn[data-tag="keto"], .etiqueta-selected[data-tag="keto"] { background: #1abc9c; }
    .etiqueta-btn[data-tag="sin-azucar"], .etiqueta-selected[data-tag="sin-azucar"] { background: #16a085; }
    
    /* Caracter√≠sticas */
    .etiqueta-btn[data-tag="picante"], .etiqueta-selected[data-tag="picante"] { background: #e74c3c; }
    .etiqueta-btn[data-tag="muy-picante"], .etiqueta-selected[data-tag="muy-picante"] { background: #c0392b; }
    .etiqueta-btn[data-tag="frio"], .etiqueta-selected[data-tag="frio"] { background: #00bcd4; }
    .etiqueta-btn[data-tag="caliente"], .etiqueta-selected[data-tag="caliente"] { background: #ff9800; }
    .etiqueta-btn[data-tag="casero"], .etiqueta-selected[data-tag="casero"] { background: #795548; }
    
    /* Caf√© y Panader√≠a */
    .etiqueta-btn[data-tag="cafe"], .etiqueta-selected[data-tag="cafe"] { background: #5d4037; }
    .etiqueta-btn[data-tag="te"], .etiqueta-selected[data-tag="te"] { background: #689f38; }
    .etiqueta-btn[data-tag="dulce"], .etiqueta-selected[data-tag="dulce"] { background: #ec407a; }
    .etiqueta-btn[data-tag="salado"], .etiqueta-selected[data-tag="salado"] { background: #78909c; }
    .etiqueta-btn[data-tag="artesanal"], .etiqueta-selected[data-tag="artesanal"] { background: #8d6e63; }
    .etiqueta-btn[data-tag="recien-horneado"], .etiqueta-selected[data-tag="recien-horneado"] { background: #d84315; }
    
    /* Porci√≥n */
    .etiqueta-btn[data-tag="grande"], .etiqueta-selected[data-tag="grande"] { background: #3f51b5; }
    .etiqueta-btn[data-tag="mediano"], .etiqueta-selected[data-tag="mediano"] { background: #5c6bc0; }
    .etiqueta-btn[data-tag="pequeno"], .etiqueta-selected[data-tag="pequeno"] { background: #7986cb; }
    .etiqueta-btn[data-tag="para-compartir"], .etiqueta-selected[data-tag="para-compartir"] { background: #673ab7; }
    
    /* Otros */
    .etiqueta-btn[data-tag="organico"], .etiqueta-selected[data-tag="organico"] { background: #4caf50; }
    .etiqueta-btn[data-tag="local"], .etiqueta-selected[data-tag="local"] { background: #607d8b; }
    .etiqueta-btn[data-tag="temporada"], .etiqueta-selected[data-tag="temporada"] { background: #ff7043; }
    .etiqueta-btn[data-tag="kosher"], .etiqueta-selected[data-tag="kosher"] { background: #5e35b1; }
    .etiqueta-btn[data-tag="halal"], .etiqueta-selected[data-tag="halal"] { background: #00897b; }
    
    /* Etiquetas personalizadas */
    .etiqueta-btn.custom-tag, .etiqueta-selected.custom-tag { background: #34495e; }
    
    /* Responsive */
    @media (max-width: 768px) {
        .etiquetas-standard {
            padding: 0.75rem;
        }
        
        .etiqueta-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
    }
</style>

<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-hamburger" style="color: #e74c3c; margin-right: 0.5rem;"></i>
            Mis Platos
        </h2>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn-secondary" onclick="abrirModalCategoria()">
                <i class="fas fa-folder-plus"></i> Nueva Categor√≠a
            </button>
            <button class="btn-primary" onclick="abrirModalPlato()">
                <i class="fas fa-plus"></i> Nuevo Plato
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="field is-grouped" style="margin-bottom: 1.5rem;">
        <div class="control is-expanded">
            <input class="input" type="text" id="buscarPlato" placeholder="Buscar plato...">
        </div>
        <div class="control">
            <div class="select">
                <select id="filtroCategoria">
                    <option value="">Todas las categor√≠as</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Tabla de Platos -->
    <div class="table-container">
        <table class="data-table" id="tablaPlatos">
            <thead>
                <tr>
                    <th style="width: 60px;">Imagen</th>
                    <th>Nombre</th>
                    <th>Categor√≠a</th>
                    <th>Precio</th>
                    <th>Estado</th>
                    <th style="width: 120px;">Acciones</th>
                </tr>
            </thead>
            <tbody id="platosBody">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p style="margin-top: 1rem; color: #7f8c8d;">Cargando platos...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nuevo/Editar Plato -->
<div class="modal-overlay" id="modalPlato">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalPlatoTitulo">Nuevo Plato</h3>
            <button class="modal-close" onclick="cerrarModalPlato()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formPlato">
                <input type="hidden" id="platoId">
                
                <div class="form-group">
                    <label class="form-label">Nombre del Plato *</label>
                    <input type="text" class="form-input" id="platoNombre" required placeholder="Ej: Hamburguesa Cl√°sica">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Categor√≠a *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select class="form-input" id="platoCategoria" required style="flex: 1;">
                            <option value="">Seleccionar categor√≠a</option>
                            {% for cat in categorias %}
                                <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn-secondary" onclick="abrirModalCategoria()" style="white-space: nowrap; padding: 0.5rem 0.75rem;" title="Crear nueva categor√≠a">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Precio *</label>
                    <input type="number" class="form-input" id="platoPrecio" required placeholder="0" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-input" id="platoDescripcion" rows="3" placeholder="Describe el plato..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Im√°genes del Plato</label>
                    <small style="color: #7f8c8d; display: block; margin-bottom: 0.5rem;">Puedes agregar m√∫ltiples im√°genes. La primera ser√° la principal.</small>
                    
                    <!-- Galer√≠a de im√°genes -->
                    <div id="imagenesGaleria" class="imagenes-galeria">
                        <!-- Las im√°genes se agregan din√°micamente -->
                        <div class="imagen-item add-imagen-btn" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-plus"></i>
                            <span>Agregar</span>
                        </div>
                    </div>
                    
                    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" onchange="subirImagenes(this)">
                    
                    <!-- Progreso de subida -->
                    <div id="uploadProgress" style="display: none; margin-top: 0.75rem;">
                        <div style="background: #eee; border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="width: 0%; height: 8px; background: linear-gradient(90deg, #e74c3c, #c0392b); transition: width 0.3s;"></div>
                        </div>
                        <p id="uploadStatus" style="font-size: 0.85rem; color: #666; margin-top: 0.25rem; text-align: center;">Subiendo im√°genes...</p>
                    </div>
                    
                    <!-- Campos ocultos con las URLs e IDs de Cloudinary -->
                    <input type="hidden" id="platoImagen">
                    <input type="hidden" id="platoImagenPublicId">
                    <input type="hidden" id="platoImagenesJson">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Etiquetas</label>
                    
                    <!-- Etiquetas Est√°ndar por Categor√≠a -->
                    <div class="etiquetas-standard" style="margin-bottom: 1rem;">
                        <!-- Popularidad -->
                        <div class="etiqueta-grupo" style="margin-bottom: 0.5rem;">
                            <small style="color: #7f8c8d; display: block; margin-bottom: 0.3rem;">‚≠ê Popularidad:</small>
                            <div class="etiquetas-opciones">
                                <span class="etiqueta-btn" data-tag="nuevo" style="background: #27ae60;">üÜï Nuevo</span>
                                <span class="etiqueta-btn" data-tag="popular" style="background: #e74c3c;">üî• Popular</span>
                                <span class="etiqueta-btn" data-tag="recomendado" style="background: #f39c12;">üë®‚Äçüç≥ Recomendado</span>
                                <span class="etiqueta-btn" data-tag="oferta" style="background: #9b59b6;">üí∞ Oferta</span>
                                <span class="etiqueta-btn" data-tag="destacado" style="background: #3498db;">‚≠ê Destacado</span>
                            </div>
                        </div>
                        
                        <!-- Restricciones Alimenticias -->
                        <div class="etiqueta-grupo" style="margin-bottom: 0.5rem;">
                            <small style="color: #7f8c8d; display: block; margin-bottom: 0.3rem;">ü•ó Dieta:</small>
                            <div class="etiquetas-opciones">
                                <span class="etiqueta-btn" data-tag="vegano" style="background: #2ecc71;">üå± Vegano</span>
                                <span class="etiqueta-btn" data-tag="vegetariano" style="background: #3498db;">ü•¨ Vegetariano</span>
                                <span class="etiqueta-btn" data-tag="sin-gluten" style="background: #9b59b6;">üåæ Sin Gluten</span>
                                <span class="etiqueta-btn" data-tag="sin-lactosa" style="background: #1abc9c;">ü•õ Sin Lactosa</span>
                                <span class="etiqueta-btn" data-tag="keto" style="background: #8e44ad;">ü•ë Keto</span>
                                <span class="etiqueta-btn" data-tag="sin-azucar" style="background: #16a085;">üç¨ Sin Az√∫car</span>
                            </div>
                        </div>
                        
                        <!-- Caracter√≠sticas -->
                        <div class="etiqueta-grupo" style="margin-bottom: 0.5rem;">
                            <small style="color: #7f8c8d; display: block; margin-bottom: 0.3rem;">üå∂Ô∏è Caracter√≠sticas:</small>
                            <div class="etiquetas-opciones">
                                <span class="etiqueta-btn" data-tag="picante" style="background: #e74c3c;">üå∂Ô∏è Picante</span>
                                <span class="etiqueta-btn" data-tag="muy-picante" style="background: #c0392b;">üî• Muy Picante</span>
                                <span class="etiqueta-btn" data-tag="frio" style="background: #3498db;">‚ùÑÔ∏è Fr√≠o</span>
                                <span class="etiqueta-btn" data-tag="caliente" style="background: #e67e22;">‚ô®Ô∏è Caliente</span>
                                <span class="etiqueta-btn" data-tag="casero" style="background: #8d6e63;">üè† Casero</span>
                            </div>
                        </div>
                        
                        <!-- Cafeter√≠a / Panader√≠a -->
                        <div class="etiqueta-grupo" style="margin-bottom: 0.5rem;">
                            <small style="color: #7f8c8d; display: block; margin-bottom: 0.3rem;">‚òï Caf√© / Panader√≠a:</small>
                            <div class="etiquetas-opciones">
                                <span class="etiqueta-btn" data-tag="cafe" style="background: #795548;">‚òï Caf√©</span>
                                <span class="etiqueta-btn" data-tag="te" style="background: #4caf50;">üçµ T√©</span>
                                <span class="etiqueta-btn" data-tag="dulce" style="background: #e91e63;">üç∞ Dulce</span>
                                <span class="etiqueta-btn" data-tag="salado" style="background: #ff9800;">ü•ê Salado</span>
                                <span class="etiqueta-btn" data-tag="artesanal" style="background: #8d6e63;">‚ú® Artesanal</span>
                                <span class="etiqueta-btn" data-tag="recien-horneado" style="background: #ff7043;">ü•ñ Reci√©n Horneado</span>
                            </div>
                        </div>
                        
                        <!-- Tama√±o -->
                        <div class="etiqueta-grupo" style="margin-bottom: 0.5rem;">
                            <small style="color: #7f8c8d; display: block; margin-bottom: 0.3rem;">üìè Porci√≥n:</small>
                            <div class="etiquetas-opciones">
                                <span class="etiqueta-btn" data-tag="grande" style="background: #3f51b5;">üì¶ Grande</span>
                                <span class="etiqueta-btn" data-tag="mediano" style="background: #2196f3;">üì¶ Mediano</span>
                                <span class="etiqueta-btn" data-tag="pequeno" style="background: #03a9f4;">üì¶ Peque√±o</span>
                                <span class="etiqueta-btn" data-tag="para-compartir" style="background: #673ab7;">üë• Para Compartir</span>
                            </div>
                        </div>
                        
                        <!-- Otros -->
                        <div class="etiqueta-grupo" style="margin-bottom: 0.5rem;">
                            <small style="color: #7f8c8d; display: block; margin-bottom: 0.3rem;">üìå Otros:</small>
                            <div class="etiquetas-opciones">
                                <span class="etiqueta-btn" data-tag="organico" style="background: #27ae60;">üåø Org√°nico</span>
                                <span class="etiqueta-btn" data-tag="local" style="background: #558b2f;">üìç Local</span>
                                <span class="etiqueta-btn" data-tag="temporada" style="background: #ff6f00;">üçÇ De Temporada</span>
                                <span class="etiqueta-btn" data-tag="kosher" style="background: #1a237e;">‚ú°Ô∏è Kosher</span>
                                <span class="etiqueta-btn" data-tag="halal" style="background: #004d40;">‚ò™Ô∏è Halal</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Etiquetas Seleccionadas -->
                    <div id="etiquetasSeleccionadas" style="min-height: 30px; padding: 0.5rem; background: #f8f9fa; border-radius: 6px; margin-bottom: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.3rem;">
                        <span style="color: #95a5a6; font-size: 0.8rem;" id="etiquetasPlaceholder">Click en las etiquetas para agregarlas...</span>
                    </div>
                    
                    <!-- Input para etiquetas personalizadas -->
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="etiquetaPersonalizada" placeholder="Agregar etiqueta personalizada..." style="flex: 1;">
                        <button type="button" class="btn-secondary" onclick="agregarEtiquetaPersonalizada()" style="white-space: nowrap;">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                    </div>
                    <small style="color: #7f8c8d;">Las etiquetas personalizadas aparecer√°n en gris</small>
                    
                    <!-- Campo oculto con las etiquetas -->
                    <input type="hidden" id="platoEtiquetas">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalPlato()">Cancelar</button>
            <button class="btn-primary" onclick="guardarPlato()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>

<!-- Modal Nueva Categor√≠a -->
<div class="modal-overlay" id="modalCategoria">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Nueva Categor√≠a</h3>
            <button class="modal-close" onclick="cerrarModalCategoria()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formCategoria">
                <div class="form-group">
                    <label class="form-label">Nombre de la Categor√≠a *</label>
                    <input type="text" class="form-input" id="categoriaNombre" required placeholder="Ej: Entrantes, Carnes, Bebidas">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalCategoria()">Cancelar</button>
            <button class="btn-primary" onclick="guardarCategoria()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let platos = [];
    let categorias = {{ categorias | default([]) | tojson }};
    let imagenesPlato = []; // Array para manejar m√∫ltiples im√°genes

    document.addEventListener('DOMContentLoaded', function() {
        cargarPlatos();
        
        // B√∫squeda en tiempo real
        document.getElementById('buscarPlato').addEventListener('input', filtrarPlatos);
        document.getElementById('filtroCategoria').addEventListener('change', filtrarPlatos);
        
        // Configurar drag & drop para la galer√≠a
        setupDragDrop();
    });

    async function cargarPlatos() {
        try {
            const res = await fetch('/api/platos');
            platos = await res.json();
            renderizarPlatos(platos);
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error al cargar los platos');
        }
    }

    function renderizarPlatos(lista) {
        const tbody = document.getElementById('platosBody');
        
        if (lista.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-utensils fa-3x" style="color: #bdc3c7; margin-bottom: 1rem;"></i>
                        <p style="color: #7f8c8d; font-size: 1.1rem;">No hay platos registrados</p>
                        <button class="btn-primary" style="margin-top: 1rem;" onclick="abrirModalPlato()">
                            <i class="fas fa-plus"></i> Agregar primer plato
                        </button>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = lista.map(plato => {
            const categoria = categorias.find(c => c.id === plato.categoria_id);
            // Obtener la imagen principal (primera del array o imagen_src)
            const imagenPrincipal = plato.imagenes && plato.imagenes.length > 0 
                ? plato.imagenes.find(i => i.es_principal) || plato.imagenes[0]
                : null;
            const imgSrc = imagenPrincipal ? imagenPrincipal.imagen_url : (plato.imagen_src || plato.imagen_url);
            const cantImagenes = plato.imagenes ? plato.imagenes.length : (plato.imagen_url ? 1 : 0);
            
            return `
                <tr>
                    <td data-label="">
                        ${imgSrc 
                            ? `<div style="position: relative;">
                                <img src="${imgSrc}" alt="${plato.nombre}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">
                                ${cantImagenes > 1 ? `<span style="position: absolute; bottom: -4px; right: -4px; background: #3498db; color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px;">+${cantImagenes-1}</span>` : ''}
                               </div>`
                            : `<div style="width: 50px; height: 50px; background: #ecf0f1; border-radius: 8px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image" style="color: #bdc3c7;"></i></div>`
                        }
                    </td>
                    <td data-label="Nombre">
                        <strong>${plato.nombre}</strong>
                        ${plato.descripcion ? `<br><small style="color: #7f8c8d;">${plato.descripcion.substring(0, 50)}${plato.descripcion.length > 50 ? '...' : ''}</small>` : ''}
                    </td>
                    <td data-label="Categor√≠a">${categoria ? categoria.nombre : '-'}</td>
                    <td data-label="Precio"><strong style="color: #27ae60;">$${Number(plato.precio).toLocaleString('es-CL')}</strong></td>
                    <td data-label="Estado">
                        <span class="tag ${plato.activo ? 'is-success' : 'is-warning'}" style="cursor: pointer;" onclick="toggleEstado(${plato.id}, ${plato.activo})">
                            ${plato.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td data-label="">
                        <button class="button is-small is-info" onclick="editarPlato(${plato.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="button is-small is-danger" onclick="eliminarPlato(${plato.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filtrarPlatos() {
        const busqueda = document.getElementById('buscarPlato').value.toLowerCase();
        const categoriaId = document.getElementById('filtroCategoria').value;
        
        let filtrados = platos;
        
        if (busqueda) {
            filtrados = filtrados.filter(p => 
                p.nombre.toLowerCase().includes(busqueda) ||
                (p.descripcion && p.descripcion.toLowerCase().includes(busqueda))
            );
        }
        
        if (categoriaId) {
            filtrados = filtrados.filter(p => p.categoria_id == categoriaId);
        }
        
        renderizarPlatos(filtrados);
    }

    // Modal Plato
    function abrirModalPlato() {
        document.getElementById('modalPlatoTitulo').textContent = 'Nuevo Plato';
        document.getElementById('formPlato').reset();
        document.getElementById('platoId').value = '';
        document.getElementById('platoImagen').value = '';
        document.getElementById('platoImagenPublicId').value = '';
        imagenesPlato = [];
        renderizarGaleria();
        limpiarEtiquetas(); // Limpiar etiquetas seleccionadas
        document.getElementById('modalPlato').classList.add('active');
    }

    function cerrarModalPlato() {
        document.getElementById('modalPlato').classList.remove('active');
    }

    function editarPlato(id) {
        const plato = platos.find(p => p.id === id);
        if (!plato) return;
        
        document.getElementById('modalPlatoTitulo').textContent = 'Editar Plato';
        document.getElementById('platoId').value = plato.id;
        document.getElementById('platoNombre').value = plato.nombre;
        document.getElementById('platoCategoria').value = plato.categoria_id;
        document.getElementById('platoPrecio').value = plato.precio;
        document.getElementById('platoDescripcion').value = plato.descripcion || '';
        document.getElementById('platoEtiquetas').value = plato.etiquetas || '';
        
        // Cargar etiquetas del plato
        cargarEtiquetasPlato(plato.etiquetas || '');
        
        // Cargar im√°genes del plato
        if (plato.imagenes && plato.imagenes.length > 0) {
            imagenesPlato = plato.imagenes.map(img => ({
                url: img.imagen_url,
                public_id: img.imagen_public_id,
                id: img.id,
                es_principal: img.es_principal
            }));
        } else if (plato.imagen_url) {
            // Compatibilidad con imagen √∫nica antigua
            imagenesPlato = [{
                url: plato.imagen_url,
                public_id: plato.imagen_public_id,
                es_principal: true
            }];
        } else {
            imagenesPlato = [];
        }
        
        // Mantener compatibilidad con campo oculto para imagen principal
        const imgPrincipal = imagenesPlato.find(i => i.es_principal) || imagenesPlato[0];
        if (imgPrincipal) {
            document.getElementById('platoImagen').value = imgPrincipal.url;
            document.getElementById('platoImagenPublicId').value = imgPrincipal.public_id || '';
        }
        
        renderizarGaleria();
        document.getElementById('modalPlato').classList.add('active');
    }

    function renderizarGaleria() {
        const galeria = document.getElementById('imagenesGaleria');
        
        let html = imagenesPlato.map((img, index) => `
            <div class="imagen-item ${img.es_principal ? 'principal' : ''}" data-index="${index}">
                <img src="${img.url}" alt="Imagen ${index + 1}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>Error</text></svg>'">
                ${img.es_principal ? '<span class="imagen-badge">Principal</span>' : ''}
                <div class="imagen-actions">
                    ${!img.es_principal ? `<button type="button" class="btn-principal" onclick="hacerPrincipal(${index})" title="Hacer principal"><i class="fas fa-star"></i></button>` : ''}
                    <button type="button" class="btn-eliminar" onclick="eliminarImagenGaleria(${index})" title="Eliminar"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
        
        // Bot√≥n para agregar m√°s (m√°ximo 5 im√°genes)
        if (imagenesPlato.length < 5) {
            html += `
                <div class="imagen-item add-imagen-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-plus"></i>
                    <span>Agregar</span>
                </div>
            `;
        }
        
        galeria.innerHTML = html;
    }

    function hacerPrincipal(index) {
        imagenesPlato.forEach((img, i) => {
            img.es_principal = (i === index);
        });
        
        // Actualizar campos ocultos con la nueva imagen principal
        const imgPrincipal = imagenesPlato[index];
        document.getElementById('platoImagen').value = imgPrincipal.url;
        document.getElementById('platoImagenPublicId').value = imgPrincipal.public_id || '';
        
        renderizarGaleria();
    }

    function eliminarImagenGaleria(index) {
        const eliminada = imagenesPlato.splice(index, 1)[0];
        
        // Si era la principal, hacer principal a la primera
        if (eliminada.es_principal && imagenesPlato.length > 0) {
            imagenesPlato[0].es_principal = true;
            document.getElementById('platoImagen').value = imagenesPlato[0].url;
            document.getElementById('platoImagenPublicId').value = imagenesPlato[0].public_id || '';
        }
        
        if (imagenesPlato.length === 0) {
            document.getElementById('platoImagen').value = '';
            document.getElementById('platoImagenPublicId').value = '';
        }
        
        renderizarGaleria();
    }

    async function guardarPlato() {
        const id = document.getElementById('platoId').value;
        
        // Preparar im√°genes para enviar
        const imagenes = imagenesPlato.map((img, index) => ({
            imagen_url: img.url,
            imagen_public_id: img.public_id,
            es_principal: img.es_principal ? 1 : 0,
            orden: index
        }));
        
        // Imagen principal para compatibilidad
        const imgPrincipal = imagenesPlato.find(i => i.es_principal) || imagenesPlato[0];
        
        const data = {
            nombre: document.getElementById('platoNombre').value,
            categoria_id: parseInt(document.getElementById('platoCategoria').value),
            precio: parseFloat(document.getElementById('platoPrecio').value),
            descripcion: document.getElementById('platoDescripcion').value,
            imagen_url: imgPrincipal ? imgPrincipal.url : '',
            imagen_public_id: imgPrincipal ? imgPrincipal.public_id : null,
            imagenes: imagenes,
            etiquetas: document.getElementById('platoEtiquetas').value
        };

        if (!data.nombre || !data.categoria_id || !data.precio) {
            alert('Por favor completa los campos obligatorios');
            return;
        }

        try {
            const url = id ? `/api/platos/${id}` : '/api/platos';
            const method = id ? 'PUT' : 'POST';
            
            const res = await fetchWithCSRF(url, {
                method: method,
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            
            if (result.success) {
                cerrarModalPlato();
                cargarPlatos();
                mostrarExito(id ? 'Plato actualizado' : 'Plato creado');
            } else {
                alert(result.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi√≥n');
        }
    }

    async function eliminarPlato(id) {
        if (!confirm('¬øEst√°s seguro de eliminar este plato?')) return;
        
        try {
            const res = await fetchWithCSRF(`/api/platos/${id}`, { method: 'DELETE' });
            const result = await res.json();
            
            if (result.success) {
                cargarPlatos();
                mostrarExito('Plato eliminado');
            } else {
                alert(result.error || 'Error al eliminar');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function toggleEstado(id, estadoActual) {
        const plato = platos.find(p => p.id === id);
        if (!plato) return;
        
        const data = {
            ...plato,
            activo: estadoActual ? 0 : 1
        };
        
        try {
            const res = await fetchWithCSRF(`/api/platos/${id}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                cargarPlatos();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Modal Categor√≠a
    function abrirModalCategoria() {
        document.getElementById('formCategoria').reset();
        document.getElementById('modalCategoria').classList.add('active');
        setTimeout(() => document.getElementById('categoriaNombre').focus(), 100);
    }

    function cerrarModalCategoria() {
        document.getElementById('modalCategoria').classList.remove('active');
    }

    async function guardarCategoria() {
        const nombre = document.getElementById('categoriaNombre').value.trim();
        
        if (!nombre) {
            alert('Por favor ingresa un nombre');
            return;
        }

        try {
            const res = await fetchWithCSRF('/api/categorias', {
                method: 'POST',
                body: JSON.stringify({ nombre: nombre })
            });
            
            const result = await res.json();
            
            if (result.success) {
                // Agregar la nueva categor√≠a al array local
                const nuevaCategoria = {
                    id: result.id,
                    nombre: nombre,
                    activo: true
                };
                categorias.push(nuevaCategoria);
                
                // Actualizar el select de categor√≠as din√°micamente
                const selectCategoria = document.getElementById('platoCategoria');
                const filtroCategoria = document.getElementById('filtroCategoria');
                
                // Agregar opci√≥n al select del formulario
                const nuevaOpcion = document.createElement('option');
                nuevaOpcion.value = result.id;
                nuevaOpcion.textContent = nombre;
                selectCategoria.appendChild(nuevaOpcion);
                
                // Seleccionar autom√°ticamente la nueva categor√≠a
                selectCategoria.value = result.id;
                
                // Tambi√©n agregar al filtro si existe
                if (filtroCategoria) {
                    const opcionFiltro = document.createElement('option');
                    opcionFiltro.value = result.id;
                    opcionFiltro.textContent = nombre;
                    filtroCategoria.appendChild(opcionFiltro);
                }
                
                cerrarModalCategoria();
                mostrarExito(`Categor√≠a "${nombre}" creada correctamente`);
            } else {
                alert(result.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi√≥n');
        }
    }

    // Notificaciones
    function mostrarExito(mensaje) {
        const notif = document.createElement('div');
        notif.className = 'notification is-success';
        notif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease;';
        notif.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i> ${mensaje}
        `;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
    }

    function mostrarError(mensaje) {
        const notif = document.createElement('div');
        notif.className = 'notification is-danger';
        notif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease;';
        notif.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i> ${mensaje}
        `;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 4000);
    }

    // ========================================
    // FUNCIONES DE SUBIDA DE IM√ÅGENES M√öLTIPLES
    // ========================================
    
    async function subirImagenes(input) {
        const files = Array.from(input.files);
        if (files.length === 0) return;
        
        // Verificar l√≠mite de im√°genes
        if (imagenesPlato.length + files.length > 5) {
            mostrarError('M√°ximo 5 im√°genes por plato');
            return;
        }
        
        const progressDiv = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const uploadStatus = document.getElementById('uploadStatus');
        
        progressDiv.style.display = 'block';
        let subidas = 0;
        
        for (const file of files) {
            // Validar tama√±o (5MB)
            if (file.size > 5 * 1024 * 1024) {
                mostrarError(`${file.name} es muy grande. M√°ximo 5MB.`);
                continue;
            }
            
            // Validar tipo
            const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                mostrarError(`${file.name}: tipo no permitido.`);
                continue;
            }
            
            progressBar.style.width = `${(subidas / files.length) * 100}%`;
            uploadStatus.textContent = `Subiendo ${subidas + 1} de ${files.length}...`;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.csrfToken },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const esPrimera = imagenesPlato.length === 0;
                    imagenesPlato.push({
                        url: result.url,
                        public_id: result.public_id,
                        es_principal: esPrimera
                    });
                    
                    // Actualizar campos ocultos con la primera imagen
                    if (esPrimera) {
                        document.getElementById('platoImagen').value = result.url;
                        document.getElementById('platoImagenPublicId').value = result.public_id || '';
                    }
                    
                    subidas++;
                } else {
                    mostrarError(result.error || `Error subiendo ${file.name}`);
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError(`Error de conexi√≥n subiendo ${file.name}`);
            }
        }
        
        progressBar.style.width = '100%';
        uploadStatus.textContent = `${subidas} imagen(es) subida(s)`;
        
        setTimeout(() => {
            progressDiv.style.display = 'none';
            progressBar.style.width = '0%';
        }, 1000);
        
        renderizarGaleria();
        input.value = ''; // Limpiar input
        
        if (subidas > 0) {
            mostrarExito(`${subidas} imagen(es) subida(s) correctamente`);
        }
    }
    
    // ============================================
    // FUNCIONES PARA MANEJO DE ETIQUETAS
    // ============================================
    let etiquetasSeleccionadas = [];
    
    const etiquetasEstandar = [
        'nuevo', 'popular', 'recomendado', 'oferta', 'destacado',
        'vegano', 'vegetariano', 'sin-gluten', 'sin-lactosa', 'keto', 'sin-azucar',
        'picante', 'muy-picante', 'frio', 'caliente', 'casero',
        'cafe', 'te', 'dulce', 'salado', 'artesanal', 'recien-horneado',
        'grande', 'mediano', 'pequeno', 'para-compartir',
        'organico', 'local', 'temporada', 'kosher', 'halal'
    ];
    
    function toggleEtiqueta(tag) {
        const btn = document.querySelector(`.etiqueta-btn[data-tag="${tag}"]`);
        const index = etiquetasSeleccionadas.indexOf(tag);
        
        if (index === -1) {
            // Agregar
            etiquetasSeleccionadas.push(tag);
            btn.classList.add('selected');
        } else {
            // Quitar
            etiquetasSeleccionadas.splice(index, 1);
            btn.classList.remove('selected');
        }
        
        actualizarEtiquetasUI();
    }
    
    function agregarEtiquetaPersonalizada() {
        const input = document.getElementById('etiquetaPersonalizada');
        let tag = input.value.trim().toLowerCase();
        
        if (!tag) return;
        
        // Normalizar: quitar acentos y caracteres especiales
        tag = tag.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                 .replace(/[^a-z0-9-]/g, '-')
                 .replace(/-+/g, '-')
                 .replace(/^-|-$/g, '');
        
        if (!tag) return;
        
        // Verificar que no exista ya
        if (etiquetasSeleccionadas.includes(tag)) {
            mostrarError('Esta etiqueta ya est√° seleccionada');
            return;
        }
        
        // Agregar
        etiquetasSeleccionadas.push(tag);
        input.value = '';
        
        actualizarEtiquetasUI();
    }
    
    function quitarEtiqueta(tag) {
        const index = etiquetasSeleccionadas.indexOf(tag);
        if (index !== -1) {
            etiquetasSeleccionadas.splice(index, 1);
            
            // Quitar selecci√≥n del bot√≥n si es est√°ndar
            const btn = document.querySelector(`.etiqueta-btn[data-tag="${tag}"]`);
            if (btn) btn.classList.remove('selected');
            
            actualizarEtiquetasUI();
        }
    }
    
    function actualizarEtiquetasUI() {
        const container = document.getElementById('etiquetasSeleccionadas');
        const hiddenInput = document.getElementById('platoEtiquetas');
        
        if (etiquetasSeleccionadas.length === 0) {
            container.innerHTML = '<span style="color: #95a5a6; font-style: italic;">Sin etiquetas seleccionadas</span>';
        } else {
            container.innerHTML = etiquetasSeleccionadas.map(tag => {
                const isCustom = !etiquetasEstandar.includes(tag);
                return `<span class="etiqueta-selected ${isCustom ? 'custom-tag' : ''}" data-tag="${tag}">
                    ${formatearEtiqueta(tag)}
                    <span class="remove-tag" onclick="quitarEtiqueta('${tag}')">&times;</span>
                </span>`;
            }).join(' ');
        }
        
        // Actualizar input oculto
        hiddenInput.value = etiquetasSeleccionadas.join(',');
    }
    
    function formatearEtiqueta(tag) {
        // Convertir tag a formato legible
        return tag.replace(/-/g, ' ')
                  .replace(/\b\w/g, l => l.toUpperCase());
    }
    
    function cargarEtiquetasPlato(etiquetasStr) {
        // Limpiar selecciones previas
        document.querySelectorAll('.etiqueta-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
        });
        etiquetasSeleccionadas = [];
        
        if (etiquetasStr && etiquetasStr.trim()) {
            const etiquetas = etiquetasStr.split(',').map(e => e.trim().toLowerCase()).filter(e => e);
            
            etiquetas.forEach(tag => {
                etiquetasSeleccionadas.push(tag);
                
                // Marcar bot√≥n si existe
                const btn = document.querySelector(`.etiqueta-btn[data-tag="${tag}"]`);
                if (btn) btn.classList.add('selected');
            });
        }
        
        actualizarEtiquetasUI();
    }
    
    function limpiarEtiquetas() {
        document.querySelectorAll('.etiqueta-btn.selected').forEach(btn => {
            btn.classList.remove('selected');
        });
        etiquetasSeleccionadas = [];
        actualizarEtiquetasUI();
    }
    
    // Manejar Enter en el input de etiqueta personalizada
    document.addEventListener('DOMContentLoaded', function() {
        const inputEtiqueta = document.getElementById('etiquetaPersonalizada');
        if (inputEtiqueta) {
            inputEtiqueta.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    agregarEtiquetaPersonalizada();
                }
            });
        }
    });
    
    function setupDragDrop() {
        const galeria = document.getElementById('imagenesGaleria');
        if (!galeria) return;
        
        galeria.addEventListener('dragover', (e) => {
            e.preventDefault();
            galeria.style.background = '#f0f8ff';
        });
        
        galeria.addEventListener('dragleave', (e) => {
            e.preventDefault();
            galeria.style.background = '';
        });
        
        galeria.addEventListener('drop', (e) => {
            e.preventDefault();
            galeria.style.background = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                subirImagenes(document.getElementById('fileInput'));
            }
        });
    }
</script>

<style>
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
{% endblock %}
