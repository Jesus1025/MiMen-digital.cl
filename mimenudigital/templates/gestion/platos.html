{% extends "gestion/base_gestion.html" %}

{% block title %}Gestión de Platos - Menú Digital{% endblock %}
{% block page_title %}Gestión de Platos{% endblock %}

{% block content %}
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-hamburger" style="color: #e74c3c; margin-right: 0.5rem;"></i>
            Mis Platos
        </h2>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn-secondary" onclick="abrirModalCategoria()">
                <i class="fas fa-folder-plus"></i> Nueva Categoría
            </button>
            <button class="btn-primary" onclick="abrirModalPlato()">
                <i class="fas fa-plus"></i> Nuevo Plato
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="field is-grouped" style="margin-bottom: 1.5rem;">
        <div class="control is-expanded">
            <input class="input" type="text" id="buscarPlato" placeholder="Buscar plato...">
        </div>
        <div class="control">
            <div class="select">
                <select id="filtroCategoria">
                    <option value="">Todas las categorías</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Tabla de Platos -->
    <div class="table-container">
        <table class="data-table" id="tablaPlatos">
            <thead>
                <tr>
                    <th style="width: 60px;">Imagen</th>
                    <th>Nombre</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>Estado</th>
                    <th style="width: 120px;">Acciones</th>
                </tr>
            </thead>
            <tbody id="platosBody">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p style="margin-top: 1rem; color: #7f8c8d;">Cargando platos...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nuevo/Editar Plato -->
<div class="modal-overlay" id="modalPlato">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalPlatoTitulo">Nuevo Plato</h3>
            <button class="modal-close" onclick="cerrarModalPlato()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formPlato">
                <input type="hidden" id="platoId">
                
                <div class="form-group">
                    <label class="form-label">Nombre del Plato *</label>
                    <input type="text" class="form-input" id="platoNombre" required placeholder="Ej: Hamburguesa Clásica">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Categoría *</label>
                    <select class="form-input" id="platoCategoria" required>
                        <option value="">Seleccionar categoría</option>
                        {% for cat in categorias %}
                            <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Precio *</label>
                    <input type="number" class="form-input" id="platoPrecio" required placeholder="0" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-input" id="platoDescripcion" rows="3" placeholder="Describe el plato..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Imagen del Plato</label>
                    
                    <!-- Tabs para elegir método -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <button type="button" class="btn-secondary image-tab active" onclick="cambiarTabImagen('upload')" id="tabUpload" style="flex: 1; padding: 0.5rem;">
                            <i class="fas fa-upload"></i> Subir
                        </button>
                        <button type="button" class="btn-secondary image-tab" onclick="cambiarTabImagen('url')" id="tabUrl" style="flex: 1; padding: 0.5rem;">
                            <i class="fas fa-link"></i> URL
                        </button>
                    </div>
                    
                    <!-- Opción Subir Imagen -->
                    <div id="uploadSection">
                        <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
                             id="dropZone" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #bdc3c7; margin-bottom: 0.5rem;"></i>
                            <p style="color: #7f8c8d; margin: 0;">Arrastra una imagen o haz clic para seleccionar</p>
                            <small style="color: #95a5a6;">PNG, JPG, GIF, WEBP (máx. 5MB)</small>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="subirImagen(this)">
                        <div id="uploadProgress" style="display: none; margin-top: 0.5rem;">
                            <progress class="progress is-primary" max="100" style="height: 8px;"></progress>
                        </div>
                    </div>
                    
                    <!-- Opción URL -->
                    <div id="urlSection" style="display: none;">
                        <input type="url" class="form-input" id="platoImagenUrl" placeholder="https://ejemplo.com/imagen.jpg" onchange="previewImagenUrl()">
                    </div>
                    
                    <!-- Preview de imagen -->
                    <div id="imagenPreview" style="margin-top: 0.75rem; display: none;">
                        <div style="position: relative; display: inline-block;">
                            <img id="previewImg" src="" alt="Preview" style="max-width: 150px; max-height: 100px; border-radius: 8px; object-fit: cover;">
                            <button type="button" onclick="eliminarImagen()" style="position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">
                                <i class="fas fa-times" style="font-size: 12px;"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Campo oculto con la URL final -->
                    <input type="hidden" id="platoImagen">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Etiquetas (separadas por coma)</label>
                    <input type="text" class="form-input" id="platoEtiquetas" placeholder="nuevo, picante, vegano">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalPlato()">Cancelar</button>
            <button class="btn-primary" onclick="guardarPlato()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>

<!-- Modal Nueva Categoría -->
<div class="modal-overlay" id="modalCategoria">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Nueva Categoría</h3>
            <button class="modal-close" onclick="cerrarModalCategoria()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formCategoria">
                <div class="form-group">
                    <label class="form-label">Nombre de la Categoría *</label>
                    <input type="text" class="form-input" id="categoriaNombre" required placeholder="Ej: Entrantes, Carnes, Bebidas">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalCategoria()">Cancelar</button>
            <button class="btn-primary" onclick="guardarCategoria()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let platos = [];
    let categorias = {{ categorias | default([]) | tojson }};

    document.addEventListener('DOMContentLoaded', function() {
        cargarPlatos();
        
        // Búsqueda en tiempo real
        document.getElementById('buscarPlato').addEventListener('input', filtrarPlatos);
        document.getElementById('filtroCategoria').addEventListener('change', filtrarPlatos);
    });

    async function cargarPlatos() {
        try {
            const res = await fetch('/api/platos');
            platos = await res.json();
            renderizarPlatos(platos);
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error al cargar los platos');
        }
    }

    function renderizarPlatos(lista) {
        const tbody = document.getElementById('platosBody');
        
        if (lista.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-utensils fa-3x" style="color: #bdc3c7; margin-bottom: 1rem;"></i>
                        <p style="color: #7f8c8d; font-size: 1.1rem;">No hay platos registrados</p>
                        <button class="btn-primary" style="margin-top: 1rem;" onclick="abrirModalPlato()">
                            <i class="fas fa-plus"></i> Agregar primer plato
                        </button>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = lista.map(plato => {
            const categoria = categorias.find(c => c.id === plato.categoria_id);
            return `
                <tr>
                    <td>
                        ${plato.imagen_src 
                            ? `<img src="${plato.imagen_src}" srcset="${plato.imagen_srcset || ''}" alt="${plato.nombre}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">`
                            : `<div style="width: 50px; height: 50px; background: #ecf0f1; border-radius: 8px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image" style="color: #bdc3c7;"></i></div>`
                        }
                    </td>
                    <td>
                        <strong>${plato.nombre}</strong>
                        ${plato.descripcion ? `<br><small style="color: #7f8c8d;">${plato.descripcion.substring(0, 50)}...</small>` : ''}
                    </td>
                    <td>${categoria ? categoria.nombre : '-'}</td>
                    <td><strong style="color: #27ae60;">$${Number(plato.precio).toLocaleString()}</strong></td>
                    <td>
                        <span class="tag ${plato.activo ? 'is-success' : 'is-warning'}" style="cursor: pointer;" onclick="toggleEstado(${plato.id}, ${plato.activo})">
                            ${plato.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <button class="button is-small is-info" onclick="editarPlato(${plato.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="button is-small is-danger" onclick="eliminarPlato(${plato.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filtrarPlatos() {
        const busqueda = document.getElementById('buscarPlato').value.toLowerCase();
        const categoriaId = document.getElementById('filtroCategoria').value;
        
        let filtrados = platos;
        
        if (busqueda) {
            filtrados = filtrados.filter(p => 
                p.nombre.toLowerCase().includes(busqueda) ||
                (p.descripcion && p.descripcion.toLowerCase().includes(busqueda))
            );
        }
        
        if (categoriaId) {
            filtrados = filtrados.filter(p => p.categoria_id == categoriaId);
        }
        
        renderizarPlatos(filtrados);
    }

    // Modal Plato
    function abrirModalPlato() {
        document.getElementById('modalPlatoTitulo').textContent = 'Nuevo Plato';
        document.getElementById('formPlato').reset();
        document.getElementById('platoId').value = '';
        document.getElementById('platoImagen').value = '';
        document.getElementById('platoImagenUrl').value = '';
        document.getElementById('imagenPreview').style.display = 'none';
        resetDropZone();
        cambiarTabImagen('upload');
        document.getElementById('modalPlato').classList.add('active');
    }

    function cerrarModalPlato() {
        document.getElementById('modalPlato').classList.remove('active');
    }

    function editarPlato(id) {
        const plato = platos.find(p => p.id === id);
        if (!plato) return;
        
        document.getElementById('modalPlatoTitulo').textContent = 'Editar Plato';
        document.getElementById('platoId').value = plato.id;
        document.getElementById('platoNombre').value = plato.nombre;
        document.getElementById('platoCategoria').value = plato.categoria_id;
        document.getElementById('platoPrecio').value = plato.precio;
        document.getElementById('platoDescripcion').value = plato.descripcion || '';
        document.getElementById('platoImagen').value = plato.imagen_url || '';
        document.getElementById('platoEtiquetas').value = plato.etiquetas || '';
        
        // Si tiene imagen, mostrar preview
        if (plato.imagen_url) {
            mostrarPreviewImagen(plato.imagen_url);
        } else {
            document.getElementById('imagenPreview').style.display = 'none';
            resetDropZone();
        }
        
        document.getElementById('modalPlato').classList.add('active');
    }

    async function guardarPlato() {
        const id = document.getElementById('platoId').value;
        const data = {
            nombre: document.getElementById('platoNombre').value,
            categoria_id: parseInt(document.getElementById('platoCategoria').value),
            precio: parseFloat(document.getElementById('platoPrecio').value),
            descripcion: document.getElementById('platoDescripcion').value,
            imagen_url: document.getElementById('platoImagen').value,
            etiquetas: document.getElementById('platoEtiquetas').value
        };

        if (!data.nombre || !data.categoria_id || !data.precio) {
            alert('Por favor completa los campos obligatorios');
            return;
        }

        try {
            const url = id ? `/api/platos/${id}` : '/api/platos';
            const method = id ? 'PUT' : 'POST';
            
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            
            if (result.success) {
                cerrarModalPlato();
                cargarPlatos();
                mostrarExito(id ? 'Plato actualizado' : 'Plato creado');
            } else {
                alert(result.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }

    async function eliminarPlato(id) {
        if (!confirm('¿Estás seguro de eliminar este plato?')) return;
        
        try {
            const res = await fetch(`/api/platos/${id}`, { method: 'DELETE' });
            const result = await res.json();
            
            if (result.success) {
                cargarPlatos();
                mostrarExito('Plato eliminado');
            } else {
                alert(result.error || 'Error al eliminar');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function toggleEstado(id, estadoActual) {
        const plato = platos.find(p => p.id === id);
        if (!plato) return;
        
        const data = {
            ...plato,
            activo: estadoActual ? 0 : 1
        };
        
        try {
            const res = await fetch(`/api/platos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                cargarPlatos();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Modal Categoría
    function abrirModalCategoria() {
        document.getElementById('formCategoria').reset();
        document.getElementById('modalCategoria').classList.add('active');
    }

    function cerrarModalCategoria() {
        document.getElementById('modalCategoria').classList.remove('active');
    }

    async function guardarCategoria() {
        const nombre = document.getElementById('categoriaNombre').value;
        
        if (!nombre) {
            alert('Por favor ingresa un nombre');
            return;
        }

        try {
            const res = await fetch('/api/categorias', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: nombre })
            });
            
            const result = await res.json();
            
            if (result.success) {
                cerrarModalCategoria();
                // Recargar página para actualizar categorías
                location.reload();
            } else {
                alert(result.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }

    // Notificaciones
    function mostrarExito(mensaje) {
        const notif = document.createElement('div');
        notif.className = 'notification is-success';
        notif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease;';
        notif.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i> ${mensaje}
        `;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
    }

    function mostrarError(mensaje) {
        const notif = document.createElement('div');
        notif.className = 'notification is-danger';
        notif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease;';
        notif.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i> ${mensaje}
        `;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 4000);
    }

    // ========================================
    // FUNCIONES DE SUBIDA DE IMAGEN
    // ========================================
    
    function cambiarTabImagen(tab) {
        const uploadSection = document.getElementById('uploadSection');
        const urlSection = document.getElementById('urlSection');
        const tabUpload = document.getElementById('tabUpload');
        const tabUrl = document.getElementById('tabUrl');
        
        if (tab === 'upload') {
            uploadSection.style.display = 'block';
            urlSection.style.display = 'none';
            tabUpload.classList.add('active');
            tabUpload.style.background = '#e74c3c';
            tabUpload.style.color = 'white';
            tabUrl.classList.remove('active');
            tabUrl.style.background = '#ecf0f1';
            tabUrl.style.color = '#2c3e50';
        } else {
            uploadSection.style.display = 'none';
            urlSection.style.display = 'block';
            tabUrl.classList.add('active');
            tabUrl.style.background = '#e74c3c';
            tabUrl.style.color = 'white';
            tabUpload.classList.remove('active');
            tabUpload.style.background = '#ecf0f1';
            tabUpload.style.color = '#2c3e50';
        }
    }

    async function subirImagen(input) {
        const file = input.files[0];
        if (!file) return;
        
        // Validar tamaño (5MB)
        if (file.size > 5 * 1024 * 1024) {
            mostrarError('La imagen es muy grande. Máximo 5MB.');
            return;
        }
        
        // Validar tipo
        const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            mostrarError('Tipo de archivo no permitido.');
            return;
        }
        
        // Mostrar progreso
        const progressDiv = document.getElementById('uploadProgress');
        const dropZone = document.getElementById('dropZone');
        progressDiv.style.display = 'block';
        dropZone.style.borderColor = '#3498db';
        dropZone.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3498db;"></i><p style="color: #3498db;">Subiendo...</p>';
        
        const formData = new FormData();
        formData.append('image', file);
        
        try {
            const response = await fetch('/api/upload-image', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Guardar URL en campo oculto
                document.getElementById('platoImagen').value = result.url;
                
                // Mostrar preview
                mostrarPreviewImagen(result.url);
                mostrarExito('Imagen subida correctamente');
            } else {
                mostrarError(result.error || 'Error al subir imagen');
                resetDropZone();
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error de conexión al subir imagen');
            resetDropZone();
        }
        
        progressDiv.style.display = 'none';
    }

    function previewImagenUrl() {
        const url = document.getElementById('platoImagenUrl').value;
        if (url) {
            document.getElementById('platoImagen').value = url;
            mostrarPreviewImagen(url);
        }
    }

    function mostrarPreviewImagen(url) {
        const preview = document.getElementById('imagenPreview');
        const img = document.getElementById('previewImg');
        img.src = url;
        preview.style.display = 'block';
        
        // Ocultar drop zone
        const dropZone = document.getElementById('dropZone');
        dropZone.style.display = 'none';
    }

    function eliminarImagen() {
        document.getElementById('platoImagen').value = '';
        document.getElementById('platoImagenUrl').value = '';
        document.getElementById('imagenPreview').style.display = 'none';
        resetDropZone();
    }

    function resetDropZone() {
        const dropZone = document.getElementById('dropZone');
        dropZone.style.display = 'block';
        dropZone.style.borderColor = '#ddd';
        dropZone.innerHTML = `
            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #bdc3c7; margin-bottom: 0.5rem;"></i>
            <p style="color: #7f8c8d; margin: 0;">Arrastra una imagen o haz clic para seleccionar</p>
            <small style="color: #95a5a6;">PNG, JPG, GIF, WEBP (máx. 5MB)</small>
        `;
    }

    // Drag & Drop
    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('dropZone');
        
        if (dropZone) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#3498db';
                dropZone.style.background = '#f0f8ff';
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ddd';
                dropZone.style.background = 'transparent';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ddd';
                dropZone.style.background = 'transparent';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    subirImagen(document.getElementById('fileInput'));
                }
            });
        }
    });
</script>

<style>
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .image-tab.active {
        background: #e74c3c !important;
        color: white !important;
    }
</style>
{% endblock %}
