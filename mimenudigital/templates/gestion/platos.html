{% extends "gestion/base_gestion.html" %}

{% block title %}Gestión de Platos - Menú Digital{% endblock %}
{% block page_title %}Gestión de Platos{% endblock %}

{% block content %}
<style>
    /* Mejoras móviles para gestión de platos */
    @media (max-width: 768px) {
        .card-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch !important;
        }
        
        .card-header > div {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .card-header .btn-primary,
        .card-header .btn-secondary {
            width: 100%;
            justify-content: center;
        }
        
        .field.is-grouped {
            flex-direction: column;
        }
        
        .field.is-grouped .control {
            margin-bottom: 0.5rem;
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Convertir tabla a tarjetas en móvil */
        .data-table thead {
            display: none;
        }
        
        .data-table tbody tr {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
        }
        
        .data-table tbody td {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border: none !important;
        }
        
        .data-table tbody td:before {
            content: attr(data-label);
            font-weight: 600;
            color: #7f8c8d;
            min-width: 80px;
            font-size: 0.85rem;
        }
        
        .data-table tbody td:first-child {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .data-table tbody td:first-child:before {
            display: none;
        }
        
        .data-table tbody td:first-child img,
        .data-table tbody td:first-child > div {
            width: 60px !important;
            height: 60px !important;
        }
        
        .data-table tbody td:last-child {
            justify-content: flex-end;
            padding-top: 1rem;
            margin-top: 0.5rem;
            border-top: 1px solid #eee !important;
        }
        
        .data-table tbody td:last-child:before {
            display: none;
        }
        
        .modal-content {
            width: 95%;
            max-width: 95%;
            margin: 0.5rem;
            max-height: 95vh;
        }
        
        .modal-body {
            max-height: 75vh;
            overflow-y: auto;
            padding: 1rem;
        }
        
        #dropZone {
            padding: 1rem !important;
        }
        
        #dropZone p {
            font-size: 0.85rem;
        }
        
        /* Galería de imágenes en móvil */
        .imagenes-galeria {
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 0.5rem !important;
        }
        
        .imagen-item {
            height: 80px !important;
        }
    }
    
    @media (max-width: 480px) {
        .card-title {
            font-size: 1.1rem;
        }
        
        .btn-primary, .btn-secondary {
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }
        
        .modal-title {
            font-size: 1.1rem;
        }
        
        .form-label {
            font-size: 0.9rem;
        }
        
        .form-input {
            font-size: 16px; /* Evita zoom en iOS */
        }
        
        .imagenes-galeria {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
    
    /* Estilos para galería de imágenes múltiples */
    .imagenes-galeria {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        margin-top: 0.75rem;
    }
    
    .imagen-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        height: 100px;
        background: #f5f5f5;
        border: 2px solid transparent;
        transition: all 0.2s ease;
    }
    
    .imagen-item:hover {
        border-color: #e74c3c;
    }
    
    .imagen-item.principal {
        border-color: #27ae60;
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.3);
    }
    
    .imagen-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .imagen-item .imagen-actions {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .imagen-item:hover .imagen-actions {
        opacity: 1;
    }
    
    .imagen-actions button {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .btn-principal {
        background: #27ae60;
        color: white;
    }
    
    .btn-eliminar {
        background: #e74c3c;
        color: white;
    }
    
    .imagen-badge {
        position: absolute;
        bottom: 4px;
        left: 4px;
        background: #27ae60;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
    }
    
    .add-imagen-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #fef5f5;
        border: 2px dashed #e74c3c;
        cursor: pointer;
        color: #e74c3c;
        transition: all 0.2s ease;
    }
    
    .add-imagen-btn:hover {
        background: #fee;
        border-color: #c0392b;
    }
    
    .add-imagen-btn i {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
    }
    
    .add-imagen-btn span {
        font-size: 0.75rem;
        font-weight: 500;
    }
</style>

<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-hamburger" style="color: #e74c3c; margin-right: 0.5rem;"></i>
            Mis Platos
        </h2>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn-secondary" onclick="abrirModalCategoria()">
                <i class="fas fa-folder-plus"></i> Nueva Categoría
            </button>
            <button class="btn-primary" onclick="abrirModalPlato()">
                <i class="fas fa-plus"></i> Nuevo Plato
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="field is-grouped" style="margin-bottom: 1.5rem;">
        <div class="control is-expanded">
            <input class="input" type="text" id="buscarPlato" placeholder="Buscar plato...">
        </div>
        <div class="control">
            <div class="select">
                <select id="filtroCategoria">
                    <option value="">Todas las categorías</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Tabla de Platos -->
    <div class="table-container">
        <table class="data-table" id="tablaPlatos">
            <thead>
                <tr>
                    <th style="width: 60px;">Imagen</th>
                    <th>Nombre</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>Estado</th>
                    <th style="width: 120px;">Acciones</th>
                </tr>
            </thead>
            <tbody id="platosBody">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p style="margin-top: 1rem; color: #7f8c8d;">Cargando platos...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nuevo/Editar Plato -->
<div class="modal-overlay" id="modalPlato">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalPlatoTitulo">Nuevo Plato</h3>
            <button class="modal-close" onclick="cerrarModalPlato()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formPlato">
                <input type="hidden" id="platoId">
                
                <div class="form-group">
                    <label class="form-label">Nombre del Plato *</label>
                    <input type="text" class="form-input" id="platoNombre" required placeholder="Ej: Hamburguesa Clásica">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Categoría *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select class="form-input" id="platoCategoria" required style="flex: 1;">
                            <option value="">Seleccionar categoría</option>
                            {% for cat in categorias %}
                                <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn-secondary" onclick="abrirModalCategoria()" style="white-space: nowrap; padding: 0.5rem 0.75rem;" title="Crear nueva categoría">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Precio *</label>
                    <input type="number" class="form-input" id="platoPrecio" required placeholder="0" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-input" id="platoDescripcion" rows="3" placeholder="Describe el plato..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Imágenes del Plato</label>
                    <small style="color: #7f8c8d; display: block; margin-bottom: 0.5rem;">Puedes agregar múltiples imágenes. La primera será la principal.</small>
                    
                    <!-- Galería de imágenes -->
                    <div id="imagenesGaleria" class="imagenes-galeria">
                        <!-- Las imágenes se agregan dinámicamente -->
                        <div class="imagen-item add-imagen-btn" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-plus"></i>
                            <span>Agregar</span>
                        </div>
                    </div>
                    
                    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" onchange="subirImagenes(this)">
                    
                    <!-- Progreso de subida -->
                    <div id="uploadProgress" style="display: none; margin-top: 0.75rem;">
                        <div style="background: #eee; border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="width: 0%; height: 8px; background: linear-gradient(90deg, #e74c3c, #c0392b); transition: width 0.3s;"></div>
                        </div>
                        <p id="uploadStatus" style="font-size: 0.85rem; color: #666; margin-top: 0.25rem; text-align: center;">Subiendo imágenes...</p>
                    </div>
                    
                    <!-- Campos ocultos con las URLs e IDs de Cloudinary -->
                    <input type="hidden" id="platoImagen">
                    <input type="hidden" id="platoImagenPublicId">
                    <input type="hidden" id="platoImagenesJson">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Etiquetas (separadas por coma)</label>
                    <input type="text" class="form-input" id="platoEtiquetas" placeholder="nuevo, picante, vegano">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalPlato()">Cancelar</button>
            <button class="btn-primary" onclick="guardarPlato()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>

<!-- Modal Nueva Categoría -->
<div class="modal-overlay" id="modalCategoria">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Nueva Categoría</h3>
            <button class="modal-close" onclick="cerrarModalCategoria()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formCategoria">
                <div class="form-group">
                    <label class="form-label">Nombre de la Categoría *</label>
                    <input type="text" class="form-input" id="categoriaNombre" required placeholder="Ej: Entrantes, Carnes, Bebidas">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalCategoria()">Cancelar</button>
            <button class="btn-primary" onclick="guardarCategoria()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let platos = [];
    let categorias = {{ categorias | default([]) | tojson }};
    let imagenesPlato = []; // Array para manejar múltiples imágenes

    document.addEventListener('DOMContentLoaded', function() {
        cargarPlatos();
        
        // Búsqueda en tiempo real
        document.getElementById('buscarPlato').addEventListener('input', filtrarPlatos);
        document.getElementById('filtroCategoria').addEventListener('change', filtrarPlatos);
        
        // Configurar drag & drop para la galería
        setupDragDrop();
    });

    async function cargarPlatos() {
        try {
            const res = await fetch('/api/platos');
            platos = await res.json();
            renderizarPlatos(platos);
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error al cargar los platos');
        }
    }

    function renderizarPlatos(lista) {
        const tbody = document.getElementById('platosBody');
        
        if (lista.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-utensils fa-3x" style="color: #bdc3c7; margin-bottom: 1rem;"></i>
                        <p style="color: #7f8c8d; font-size: 1.1rem;">No hay platos registrados</p>
                        <button class="btn-primary" style="margin-top: 1rem;" onclick="abrirModalPlato()">
                            <i class="fas fa-plus"></i> Agregar primer plato
                        </button>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = lista.map(plato => {
            const categoria = categorias.find(c => c.id === plato.categoria_id);
            // Obtener la imagen principal (primera del array o imagen_src)
            const imagenPrincipal = plato.imagenes && plato.imagenes.length > 0 
                ? plato.imagenes.find(i => i.es_principal) || plato.imagenes[0]
                : null;
            const imgSrc = imagenPrincipal ? imagenPrincipal.imagen_url : (plato.imagen_src || plato.imagen_url);
            const cantImagenes = plato.imagenes ? plato.imagenes.length : (plato.imagen_url ? 1 : 0);
            
            return `
                <tr>
                    <td data-label="">
                        ${imgSrc 
                            ? `<div style="position: relative;">
                                <img src="${imgSrc}" alt="${plato.nombre}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">
                                ${cantImagenes > 1 ? `<span style="position: absolute; bottom: -4px; right: -4px; background: #3498db; color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px;">+${cantImagenes-1}</span>` : ''}
                               </div>`
                            : `<div style="width: 50px; height: 50px; background: #ecf0f1; border-radius: 8px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image" style="color: #bdc3c7;"></i></div>`
                        }
                    </td>
                    <td data-label="Nombre">
                        <strong>${plato.nombre}</strong>
                        ${plato.descripcion ? `<br><small style="color: #7f8c8d;">${plato.descripcion.substring(0, 50)}${plato.descripcion.length > 50 ? '...' : ''}</small>` : ''}
                    </td>
                    <td data-label="Categoría">${categoria ? categoria.nombre : '-'}</td>
                    <td data-label="Precio"><strong style="color: #27ae60;">$${Number(plato.precio).toLocaleString('es-CL')}</strong></td>
                    <td data-label="Estado">
                        <span class="tag ${plato.activo ? 'is-success' : 'is-warning'}" style="cursor: pointer;" onclick="toggleEstado(${plato.id}, ${plato.activo})">
                            ${plato.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td data-label="">
                        <button class="button is-small is-info" onclick="editarPlato(${plato.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="button is-small is-danger" onclick="eliminarPlato(${plato.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filtrarPlatos() {
        const busqueda = document.getElementById('buscarPlato').value.toLowerCase();
        const categoriaId = document.getElementById('filtroCategoria').value;
        
        let filtrados = platos;
        
        if (busqueda) {
            filtrados = filtrados.filter(p => 
                p.nombre.toLowerCase().includes(busqueda) ||
                (p.descripcion && p.descripcion.toLowerCase().includes(busqueda))
            );
        }
        
        if (categoriaId) {
            filtrados = filtrados.filter(p => p.categoria_id == categoriaId);
        }
        
        renderizarPlatos(filtrados);
    }

    // Modal Plato
    function abrirModalPlato() {
        document.getElementById('modalPlatoTitulo').textContent = 'Nuevo Plato';
        document.getElementById('formPlato').reset();
        document.getElementById('platoId').value = '';
        document.getElementById('platoImagen').value = '';
        document.getElementById('platoImagenPublicId').value = '';
        imagenesPlato = [];
        renderizarGaleria();
        document.getElementById('modalPlato').classList.add('active');
    }

    function cerrarModalPlato() {
        document.getElementById('modalPlato').classList.remove('active');
    }

    function editarPlato(id) {
        const plato = platos.find(p => p.id === id);
        if (!plato) return;
        
        document.getElementById('modalPlatoTitulo').textContent = 'Editar Plato';
        document.getElementById('platoId').value = plato.id;
        document.getElementById('platoNombre').value = plato.nombre;
        document.getElementById('platoCategoria').value = plato.categoria_id;
        document.getElementById('platoPrecio').value = plato.precio;
        document.getElementById('platoDescripcion').value = plato.descripcion || '';
        document.getElementById('platoEtiquetas').value = plato.etiquetas || '';
        
        // Cargar imágenes del plato
        if (plato.imagenes && plato.imagenes.length > 0) {
            imagenesPlato = plato.imagenes.map(img => ({
                url: img.imagen_url,
                public_id: img.imagen_public_id,
                id: img.id,
                es_principal: img.es_principal
            }));
        } else if (plato.imagen_url) {
            // Compatibilidad con imagen única antigua
            imagenesPlato = [{
                url: plato.imagen_url,
                public_id: plato.imagen_public_id,
                es_principal: true
            }];
        } else {
            imagenesPlato = [];
        }
        
        // Mantener compatibilidad con campo oculto para imagen principal
        const imgPrincipal = imagenesPlato.find(i => i.es_principal) || imagenesPlato[0];
        if (imgPrincipal) {
            document.getElementById('platoImagen').value = imgPrincipal.url;
            document.getElementById('platoImagenPublicId').value = imgPrincipal.public_id || '';
        }
        
        renderizarGaleria();
        document.getElementById('modalPlato').classList.add('active');
    }

    function renderizarGaleria() {
        const galeria = document.getElementById('imagenesGaleria');
        
        let html = imagenesPlato.map((img, index) => `
            <div class="imagen-item ${img.es_principal ? 'principal' : ''}" data-index="${index}">
                <img src="${img.url}" alt="Imagen ${index + 1}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>Error</text></svg>'">
                ${img.es_principal ? '<span class="imagen-badge">Principal</span>' : ''}
                <div class="imagen-actions">
                    ${!img.es_principal ? `<button type="button" class="btn-principal" onclick="hacerPrincipal(${index})" title="Hacer principal"><i class="fas fa-star"></i></button>` : ''}
                    <button type="button" class="btn-eliminar" onclick="eliminarImagenGaleria(${index})" title="Eliminar"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
        
        // Botón para agregar más (máximo 5 imágenes)
        if (imagenesPlato.length < 5) {
            html += `
                <div class="imagen-item add-imagen-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-plus"></i>
                    <span>Agregar</span>
                </div>
            `;
        }
        
        galeria.innerHTML = html;
    }

    function hacerPrincipal(index) {
        imagenesPlato.forEach((img, i) => {
            img.es_principal = (i === index);
        });
        
        // Actualizar campos ocultos con la nueva imagen principal
        const imgPrincipal = imagenesPlato[index];
        document.getElementById('platoImagen').value = imgPrincipal.url;
        document.getElementById('platoImagenPublicId').value = imgPrincipal.public_id || '';
        
        renderizarGaleria();
    }

    function eliminarImagenGaleria(index) {
        const eliminada = imagenesPlato.splice(index, 1)[0];
        
        // Si era la principal, hacer principal a la primera
        if (eliminada.es_principal && imagenesPlato.length > 0) {
            imagenesPlato[0].es_principal = true;
            document.getElementById('platoImagen').value = imagenesPlato[0].url;
            document.getElementById('platoImagenPublicId').value = imagenesPlato[0].public_id || '';
        }
        
        if (imagenesPlato.length === 0) {
            document.getElementById('platoImagen').value = '';
            document.getElementById('platoImagenPublicId').value = '';
        }
        
        renderizarGaleria();
    }

    async function guardarPlato() {
        const id = document.getElementById('platoId').value;
        
        // Preparar imágenes para enviar
        const imagenes = imagenesPlato.map((img, index) => ({
            imagen_url: img.url,
            imagen_public_id: img.public_id,
            es_principal: img.es_principal ? 1 : 0,
            orden: index
        }));
        
        // Imagen principal para compatibilidad
        const imgPrincipal = imagenesPlato.find(i => i.es_principal) || imagenesPlato[0];
        
        const data = {
            nombre: document.getElementById('platoNombre').value,
            categoria_id: parseInt(document.getElementById('platoCategoria').value),
            precio: parseFloat(document.getElementById('platoPrecio').value),
            descripcion: document.getElementById('platoDescripcion').value,
            imagen_url: imgPrincipal ? imgPrincipal.url : '',
            imagen_public_id: imgPrincipal ? imgPrincipal.public_id : null,
            imagenes: imagenes,
            etiquetas: document.getElementById('platoEtiquetas').value
        };

        if (!data.nombre || !data.categoria_id || !data.precio) {
            alert('Por favor completa los campos obligatorios');
            return;
        }

        try {
            const url = id ? `/api/platos/${id}` : '/api/platos';
            const method = id ? 'PUT' : 'POST';
            
            const res = await fetchWithCSRF(url, {
                method: method,
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            
            if (result.success) {
                cerrarModalPlato();
                cargarPlatos();
                mostrarExito(id ? 'Plato actualizado' : 'Plato creado');
            } else {
                alert(result.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }

    async function eliminarPlato(id) {
        if (!confirm('¿Estás seguro de eliminar este plato?')) return;
        
        try {
            const res = await fetchWithCSRF(`/api/platos/${id}`, { method: 'DELETE' });
            const result = await res.json();
            
            if (result.success) {
                cargarPlatos();
                mostrarExito('Plato eliminado');
            } else {
                alert(result.error || 'Error al eliminar');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function toggleEstado(id, estadoActual) {
        const plato = platos.find(p => p.id === id);
        if (!plato) return;
        
        const data = {
            ...plato,
            activo: estadoActual ? 0 : 1
        };
        
        try {
            const res = await fetchWithCSRF(`/api/platos/${id}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                cargarPlatos();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Modal Categoría
    function abrirModalCategoria() {
        document.getElementById('formCategoria').reset();
        document.getElementById('modalCategoria').classList.add('active');
        setTimeout(() => document.getElementById('categoriaNombre').focus(), 100);
    }

    function cerrarModalCategoria() {
        document.getElementById('modalCategoria').classList.remove('active');
    }

    async function guardarCategoria() {
        const nombre = document.getElementById('categoriaNombre').value.trim();
        
        if (!nombre) {
            alert('Por favor ingresa un nombre');
            return;
        }

        try {
            const res = await fetchWithCSRF('/api/categorias', {
                method: 'POST',
                body: JSON.stringify({ nombre: nombre })
            });
            
            const result = await res.json();
            
            if (result.success) {
                // Agregar la nueva categoría al array local
                const nuevaCategoria = {
                    id: result.id,
                    nombre: nombre,
                    activo: true
                };
                categorias.push(nuevaCategoria);
                
                // Actualizar el select de categorías dinámicamente
                const selectCategoria = document.getElementById('platoCategoria');
                const filtroCategoria = document.getElementById('filtroCategoria');
                
                // Agregar opción al select del formulario
                const nuevaOpcion = document.createElement('option');
                nuevaOpcion.value = result.id;
                nuevaOpcion.textContent = nombre;
                selectCategoria.appendChild(nuevaOpcion);
                
                // Seleccionar automáticamente la nueva categoría
                selectCategoria.value = result.id;
                
                // También agregar al filtro si existe
                if (filtroCategoria) {
                    const opcionFiltro = document.createElement('option');
                    opcionFiltro.value = result.id;
                    opcionFiltro.textContent = nombre;
                    filtroCategoria.appendChild(opcionFiltro);
                }
                
                cerrarModalCategoria();
                mostrarExito(`Categoría "${nombre}" creada correctamente`);
            } else {
                alert(result.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }

    // Notificaciones
    function mostrarExito(mensaje) {
        const notif = document.createElement('div');
        notif.className = 'notification is-success';
        notif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease;';
        notif.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i> ${mensaje}
        `;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
    }

    function mostrarError(mensaje) {
        const notif = document.createElement('div');
        notif.className = 'notification is-danger';
        notif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease;';
        notif.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i> ${mensaje}
        `;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 4000);
    }

    // ========================================
    // FUNCIONES DE SUBIDA DE IMÁGENES MÚLTIPLES
    // ========================================
    
    async function subirImagenes(input) {
        const files = Array.from(input.files);
        if (files.length === 0) return;
        
        // Verificar límite de imágenes
        if (imagenesPlato.length + files.length > 5) {
            mostrarError('Máximo 5 imágenes por plato');
            return;
        }
        
        const progressDiv = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const uploadStatus = document.getElementById('uploadStatus');
        
        progressDiv.style.display = 'block';
        let subidas = 0;
        
        for (const file of files) {
            // Validar tamaño (5MB)
            if (file.size > 5 * 1024 * 1024) {
                mostrarError(`${file.name} es muy grande. Máximo 5MB.`);
                continue;
            }
            
            // Validar tipo
            const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                mostrarError(`${file.name}: tipo no permitido.`);
                continue;
            }
            
            progressBar.style.width = `${(subidas / files.length) * 100}%`;
            uploadStatus.textContent = `Subiendo ${subidas + 1} de ${files.length}...`;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.csrfToken },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const esPrimera = imagenesPlato.length === 0;
                    imagenesPlato.push({
                        url: result.url,
                        public_id: result.public_id,
                        es_principal: esPrimera
                    });
                    
                    // Actualizar campos ocultos con la primera imagen
                    if (esPrimera) {
                        document.getElementById('platoImagen').value = result.url;
                        document.getElementById('platoImagenPublicId').value = result.public_id || '';
                    }
                    
                    subidas++;
                } else {
                    mostrarError(result.error || `Error subiendo ${file.name}`);
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError(`Error de conexión subiendo ${file.name}`);
            }
        }
        
        progressBar.style.width = '100%';
        uploadStatus.textContent = `${subidas} imagen(es) subida(s)`;
        
        setTimeout(() => {
            progressDiv.style.display = 'none';
            progressBar.style.width = '0%';
        }, 1000);
        
        renderizarGaleria();
        input.value = ''; // Limpiar input
        
        if (subidas > 0) {
            mostrarExito(`${subidas} imagen(es) subida(s) correctamente`);
        }
    }
    
    function setupDragDrop() {
        const galeria = document.getElementById('imagenesGaleria');
        if (!galeria) return;
        
        galeria.addEventListener('dragover', (e) => {
            e.preventDefault();
            galeria.style.background = '#f0f8ff';
        });
        
        galeria.addEventListener('dragleave', (e) => {
            e.preventDefault();
            galeria.style.background = '';
        });
        
        galeria.addEventListener('drop', (e) => {
            e.preventDefault();
            galeria.style.background = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                subirImagenes(document.getElementById('fileInput'));
            }
        });
    }
</script>

<style>
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
{% endblock %}
