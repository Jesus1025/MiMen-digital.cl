{% extends "base.html" %}

{% block title %}Gestión de Clientes - TekneTau{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-users"></i> Gestión de Clientes</h1>
            <div>
                <a href="/api/exportar-clientes-csv" class="btn btn-success me-2">
                    <i class="fas fa-file-csv"></i> Exportar CSV
                </a>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCliente">
                    <i class="fas fa-plus"></i> Nuevo Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Lista de Clientes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tablaClientes">
                        <thead>
                            <tr>
                                <th>RUT</th>
                                <th>Razón Social</th>
                                <th>Giro</th>
                                <th>Contacto</th>
                                <th>Fecha Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cliente in clientes %}
                            <tr>
                                <td>{{ cliente.rut }}</td>
                                <td>{{ cliente.razon_social }}</td>
                                <td>{{ cliente.giro or 'No especificado' }}</td>
                                <td>
                                    {% if cliente.telefono or cliente.email %}
                                        <small>
                                            {% if cliente.telefono %}{{ cliente.telefono }}<br>{% endif %}
                                            {% if cliente.email %}{{ cliente.email }}{% endif %}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">Sin contacto</span>
                                    {% endif %}
                                </td>
                                <td>{{ (cliente.fecha_creacion or '')[:10] if cliente.fecha_creacion else 'N/A' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary btn-editar-cliente"
                                        data-rut="{{ cliente.rut }}"
                                        data-razon_social="{{ cliente.razon_social }}"
                                        data-giro="{{ cliente.giro or '' }}"
                                        data-direccion="{{ cliente.direccion or '' }}"
                                        data-comuna="{{ cliente.comuna or '' }}"
                                        data-telefono="{{ cliente.telefono or '' }}"
                                        data-email="{{ cliente.email or '' }}"
                                        data-cuenta_corriente="{{ cliente.cuenta_corriente or '' }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger btn-eliminar-cliente"
                                        data-rut="{{ cliente.rut }}"
                                        data-nombre="{{ cliente.razon_social }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalClienteTitulo">Nuevo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCliente">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rut" class="form-label">RUT *</label>
                            <input type="text" class="form-control" id="rut" name="rut" required>
                            <div class="invalid-feedback" id="rut-feedback">Ingrese un RUT válido (ej: 12.345.678-5).</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="razon_social" class="form-label">Razón Social *</label>
                            <input type="text" class="form-control" id="razon_social" name="razon_social" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="giro" class="form-label">Giro</label>
                            <input type="text" class="form-control" id="giro" name="giro">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="comuna" class="form-label">Comuna</label>
                            <input type="text" class="form-control" id="comuna" name="comuna">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cuenta_corriente" class="form-label">Cuenta Corriente</label>
                            <input type="text" class="form-control" id="cuenta_corriente" name="cuenta_corriente" placeholder="N° cuenta">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="direccion" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="direccion" name="direccion">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="telefono" class="form-label">Celular *</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" placeholder="9 1234 5678" required>
                            <small class="text-muted">Formato: 9 XXXX XXXX (celular chileno)</small>
                            <div class="invalid-feedback" id="telefono-feedback">Ingrese un celular chileno válido (9 XXXX XXXX).</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="usuario@empresa.cl" required>
                        <small class="text-muted">Acepta: .cl, .com, .net, .org, .io, .co</small>
                        <div class="invalid-feedback" id="email-feedback">Ingrese un correo válido.</div>
                    </div>
                    <div class="alert alert-danger d-none" id="form-error" role="alert"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarCliente" onclick="guardarCliente()">Guardar Cliente</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let clienteEditando = null;
const formCliente = document.getElementById('formCliente');
const modalClienteEl = document.getElementById('modalCliente');
const btnGuardarCliente = document.getElementById('btnGuardarCliente');
const rutInput = document.getElementById('rut');
const emailInput = document.getElementById('email');
const telefonoInput = document.getElementById('telefono');
const formError = document.getElementById('form-error');

function normalizeRut(rut) {
    if (!rut) return '';
    const clean = rut.replace(/\./g, '').replace(/\s+/g, '').toUpperCase();
    if (clean.length < 2) return '';
    const body = clean.slice(0, -1);
    const dv = clean.slice(-1);
    return `${body}-${dv}`;
}

function validateRut(rut) {
    const normalized = normalizeRut(rut);
    if (!normalized.includes('-')) return false;
    const [body, dv] = normalized.split('-');
    if (!/^\d+$/.test(body)) return false;
    let total = 0;
    let factor = 2;
    for (let i = body.length - 1; i >= 0; i--) {
        total += parseInt(body[i], 10) * factor;
        factor = factor === 7 ? 2 : factor + 1;
    }
    const remainder = 11 - (total % 11);
    const dvCalc = remainder === 11 ? '0' : remainder === 10 ? 'K' : `${remainder}`;
    return dvCalc === dv;
}

// Validar email - acepta múltiples dominios
function validateEmail(email) {
    if (!email) return false;
    // Acepta .cl, .com, .net, .org, .edu, .gov, .io, .co
    return /^[^@\s]+@[^@\s]+\.(cl|com|net|org|edu|gov|io|co)$/i.test(email.trim());
}

// Validar teléfono celular chileno
function validateTelefonoChileno(telefono) {
    if (!telefono) return false;
    // Limpiar el teléfono de espacios, guiones, puntos, +56
    const clean = telefono.replace(/[\s\-\.\+]/g, '').replace(/^56/, '');
    // Debe ser 9 dígitos empezando con 9
    return /^9[0-9]{8}$/.test(clean);
}

// Formatear teléfono a formato +56 9 XXXX XXXX
function formatTelefonoChileno(telefono) {
    if (!telefono) return '';
    const clean = telefono.replace(/[\s\-\.\+]/g, '').replace(/^56/, '');
    if (clean.length === 9 && clean.startsWith('9')) {
        return `+56 ${clean.substring(0,1)} ${clean.substring(1,5)} ${clean.substring(5,9)}`;
    }
    return telefono;
}

function clearValidation() {
    [rutInput, emailInput, telefonoInput].forEach((input) => input.classList.remove('is-invalid'));
    formError.classList.add('d-none');
    formError.textContent = '';
}

function showError(message, input) {
    if (input) {
        input.classList.add('is-invalid');
        input.focus();
    }
    formError.textContent = message;
    formError.classList.remove('d-none');
}

function guardarCliente() {
    clearValidation();
    const formData = new FormData(formCliente);
    const data = Object.fromEntries(formData);

    const rut = data.rut ? data.rut.trim() : '';
    const email = data.email ? data.email.trim() : '';
    const telefono = data.telefono ? data.telefono.trim() : '';

    if (!validateRut(rut)) {
        showError('RUT inválido. Revise el dígito verificador.', rutInput);
        return;
    }

    if (!validateTelefonoChileno(telefono)) {
        showError('El teléfono debe ser un celular chileno válido (9 XXXX XXXX).', telefonoInput);
        return;
    }

    if (!validateEmail(email)) {
        showError('El email debe ser válido (.cl, .com, .net, .org, .io, .co).', emailInput);
        return;
    }

    const payload = {
        ...data,
        rut: normalizeRut(rut),
        email: email.toLowerCase(),
        telefono: formatTelefonoChileno(telefono)
    };

    const url = clienteEditando ? `/api/clientes/${encodeURIComponent(clienteEditando.rut)}` : '/api/clientes';
    const method = clienteEditando ? 'PUT' : 'POST';

    fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
        .then(async (response) => {
            const result = await response.json();
            if (!response.ok || !result.success) {
                const message = result.error || 'Ocurrió un error al guardar el cliente';
                showError(message);
                throw new Error(message);
            }
            return result;
        })
        .then(() => {
            const modal = bootstrap.Modal.getInstance(modalClienteEl) || new bootstrap.Modal(modalClienteEl);
            modal.hide();
            location.reload();
        })
        .catch((error) => {
            if (!formError.textContent) {
                showError(error.message || 'Error inesperado al guardar el cliente');
            }
        });
}

function editarCliente(cliente) {
    clienteEditando = cliente;
    document.getElementById('modalClienteTitulo').textContent = 'Editar Cliente';
    btnGuardarCliente.textContent = 'Guardar Cambios';

    rutInput.value = cliente.rut;
    document.getElementById('razon_social').value = cliente.razon_social;
    document.getElementById('giro').value = cliente.giro || '';
    document.getElementById('direccion').value = cliente.direccion || '';
    document.getElementById('comuna').value = cliente.comuna || '';
    document.getElementById('cuenta_corriente').value = cliente.cuenta_corriente || '';
    document.getElementById('telefono').value = cliente.telefono || '';
    emailInput.value = cliente.email || '';

    rutInput.readOnly = true;
    clearValidation();

    const modal = new bootstrap.Modal(modalClienteEl);
    modal.show();
}

function eliminarCliente(rut, razonSocial) {
    if (!confirm(`¿Estás seguro de que quieres eliminar al cliente "${razonSocial}"?`)) {
        return;
    }

    fetch(`/api/clientes?rut=${encodeURIComponent(rut)}`, { method: 'DELETE' })
        .then((response) => response.json())
        .then((result) => {
            if (result.success) {
                alert('Cliente eliminado exitosamente');
                location.reload();
            } else {
                showError(result.error || 'No se pudo eliminar el cliente');
            }
        })
        .catch((error) => {
            showError(error.message || 'Error al eliminar cliente');
        });
}

modalClienteEl.addEventListener('hidden.bs.modal', () => {
    formCliente.reset();
    document.getElementById('modalClienteTitulo').textContent = 'Nuevo Cliente';
    btnGuardarCliente.textContent = 'Guardar Cliente';
    rutInput.readOnly = false;
    clienteEditando = null;
    clearValidation();
});

[rutInput, emailInput, telefonoInput].forEach((input) => {
    input.addEventListener('input', () => input.classList.remove('is-invalid'));
});

// Event listeners para botones de editar y eliminar
document.addEventListener('DOMContentLoaded', function() {
    // Botones de editar
    document.querySelectorAll('.btn-editar-cliente').forEach(btn => {
        btn.addEventListener('click', function() {
            const cliente = {
                rut: this.dataset.rut,
                razon_social: this.dataset.razon_social,
                giro: this.dataset.giro,
                direccion: this.dataset.direccion,
                comuna: this.dataset.comuna,
                cuenta_corriente: this.dataset.cuenta_corriente,
                telefono: this.dataset.telefono,
                email: this.dataset.email
            };
            editarCliente(cliente);
        });
    });

    // Botones de eliminar
    document.querySelectorAll('.btn-eliminar-cliente').forEach(btn => {
        btn.addEventListener('click', function() {
            eliminarCliente(this.dataset.rut, this.dataset.nombre);
        });
    });
});
</script>
{% endblock %}