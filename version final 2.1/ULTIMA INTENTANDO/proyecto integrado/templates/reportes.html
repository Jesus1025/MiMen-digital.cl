{% extends "base.html" %}

{% block title %}Reportes - TekneTau{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="fas fa-chart-bar"></i> Sistema de Reportes</h1>
        <p class="text-muted">Genera y exporta reportes financieros y documentales completos</p>
    </div>
</div>

<!-- Filtros Generales -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-filter"></i> Filtros de Reportes</h5>
            </div>
            <div class="card-body">
                <form id="formFiltrosReportes">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Fecha Inicio</label>
                            <input type="date" class="form-control" id="filtroFechaInicio">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Fin</label>
                            <input type="date" class="form-control" id="filtroFechaFin">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tipo Documento</label>
                            <select class="form-select" id="filtroTipoDoc">
                                <option value="">Todos los documentos</option>
                                <option value="FAC">Facturas</option>
                                <option value="BOL">Boletas</option>
                                <option value="NC">Notas de Crédito</option>
                                <option value="ND">Notas de Débito</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="filtroEstado">
                                <option value="">Todos los estados</option>
                                <option value="Pagado">Pagado</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Anulado">Anulado</option>
                                <option value="Aplicada">Aplicada (NC)</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                                <i class="fas fa-search"></i> Aplicar Filtros
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="limpiarFiltros()">
                                <i class="fas fa-broom"></i> Limpiar Filtros
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Tarjetas de Reportes Rápidos -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <i class="fas fa-file-invoice-dollar fa-2x mb-3"></i>
                <h5>Reporte Anual</h5>
                <p class="mb-0">Resumen completo del año</p>
                <button class="btn btn-light btn-sm mt-2" onclick="document.getElementById('contenedorReporteAnual').scrollIntoView()">
                    <i class="fas fa-eye"></i> Ver
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-3"></i>
                <h5>Ventas Mensuales</h5>
                <p class="mb-0">Evolución de ventas</p>
                <button class="btn btn-light btn-sm mt-2" onclick="document.getElementById('tablaVentasMensuales').scrollIntoView()">
                    <i class="fas fa-eye"></i> Ver
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <i class="fas fa-money-bill-wave fa-2x mb-3"></i>
                <h5>Deudas Pendientes</h5>
                <p class="mb-0">Clientes morosos</p>
                <button class="btn btn-light btn-sm mt-2" onclick="document.getElementById('tablaDeudas').scrollIntoView()">
                    <i class="fas fa-eye"></i> Ver
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-3"></i>
                <h5>Top Clientes</h5>
                <p class="mb-0">Mejores clientes</p>
                <button class="btn btn-light btn-sm mt-2" onclick="document.getElementById('tablaTopClientes').scrollIntoView()">
                    <i class="fas fa-eye"></i> Ver
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reporte Anual -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-alt"></i> Reporte Anual
                </h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto" id="selectAnio">
                        <!-- Opciones se llenarán con JavaScript -->
                    </select>
                    <button class="btn btn-sm btn-success ms-2" onclick="exportarReporteAnualExcel(document.getElementById('selectAnio').value)">
                        <i class="fas fa-download"></i> Exportar Excel
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="contenedorReporteAnual">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <p>Selecciona un año y genera el reporte anual completo</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reporte de Ventas Mensuales -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line"></i> Ventas Mensuales
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="cargarVentasMensuales()">
                        <i class="fas fa-refresh"></i> Actualizar
                    </button>
                    <button class="btn btn-sm btn-success" onclick="exportarVentasExcel()">
                        <i class="fas fa-file-excel"></i> Exportar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tablaVentasMensuales">
                        <thead>
                            <tr>
                                <th>Año-Mes</th>
                                <th>Tipo Documento</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                                <th>IVA</th>
                                <th>Total</th>
                                <th>Tendencia</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoVentasMensuales">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    Haga clic en "Actualizar" para cargar los datos
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reporte de Deudas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-money-bill-wave"></i> Reporte de Deudas por Cliente
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="cargarReporteDeudas()">
                        <i class="fas fa-refresh"></i> Actualizar
                    </button>
                    <button class="btn btn-sm btn-success" onclick="exportarDeudasExcel()">
                        <i class="fas fa-file-excel"></i> Exportar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tablaDeudas">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>RUT</th>
                                <th>Documentos Pendientes</th>
                                <th>Total Deuda</th>
                                <th>Días Promedio Venc.</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoDeudas">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    Haga clic en "Actualizar" para cargar los datos
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Clientes -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-trophy"></i> Top 10 Clientes
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-success me-2" onclick="cargarTopClientes()">
                        <i class="fas fa-refresh"></i> Actualizar
                    </button>
                    <button class="btn btn-sm btn-success" onclick="exportarTopClientesExcel()">
                        <i class="fas fa-file-excel"></i> Exportar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tablaTopClientes">
                        <thead>
                            <tr>
                                <th>Posición</th>
                                <th>Cliente</th>
                                <th>RUT</th>
                                <th>Total Documentos</th>
                                <th>Total Facturado</th>
                                <th>Promedio por Doc.</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTopClientes">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    Haga clic en "Actualizar" para cargar los datos
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resumen Estadístico -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Resumen Financiero General</h5>
            </div>
            <div class="card-body">
                <div id="resumenFinanciero">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Facturado:</span>
                        <strong id="totalFacturado">$0</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Pagado:</span>
                        <strong id="totalPagado" class="text-success">$0</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Pendiente:</span>
                        <strong id="totalPendiente" class="text-danger">$0</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Notas Crédito:</span>
                        <strong id="totalNC" class="text-success">$0</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Notas Débito:</span>
                        <strong id="totalND" class="text-warning">$0</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Documentos por Estado</h5>
            </div>
            <div class="card-body">
                <div id="documentosEstado">
                    <div class="d-flex justify-content-between mb-2">
                        <span><span class="badge bg-success">Pagados</span></span>
                        <strong id="countPagados">0</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><span class="badge bg-warning">Pendientes</span></span>
                        <strong id="countPendientes">0</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><span class="badge bg-info">NC Aplicadas</span></span>
                        <strong id="countNC">0</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span><span class="badge bg-secondary">Anulados</span></span>
                        <strong id="countAnulados">0</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles de cliente -->
<div class="modal fade" id="modalDetalleCliente" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Documentos - <span id="nombreClienteModal"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalleDocumentosCliente"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variables globales
let filtrosActivos = {};

// Función para formatear moneda
function formatoMoneda(numero) {
    if (!numero || isNaN(numero)) return '$0';
    return '$' + new Intl.NumberFormat('es-CL', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(numero);
}

// Función para formatear fecha
function formatoFecha(fechaString) {
    if (!fechaString) return 'N/A';
    const fecha = new Date(fechaString);
    return fecha.toLocaleDateString('es-CL');
}

// Inicializar años para el reporte anual
function inicializarSelectAnio() {
    const select = document.getElementById('selectAnio');
    const currentYear = new Date().getFullYear();
    
    for (let year = currentYear; year >= currentYear - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        select.appendChild(option);
    }
}

// Generar reporte anual
function generarReporteAnual() {
    const anio = document.getElementById('selectAnio').value;
    
    fetch(`/api/reporte-anual?anio=${anio}`)
        .then(response => response.json())
        .then(reporte => {
            mostrarReporteAnual(reporte, anio);
        })
        .catch(error => {
            console.error('Error al generar reporte anual:', error);
            alert('Error al generar el reporte anual: ' + error.message);
        });
}

// Mostrar reporte anual en la interfaz
function mostrarReporteAnual(reporte, anio) {
    const contenedor = document.getElementById('contenedorReporteAnual');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6>Resumen Anual ${anio}</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Facturado:</span>
                            <strong>${formatoMoneda(reporte.total_facturado_anual)}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Pagado:</span>
                            <strong class="text-success">${formatoMoneda(reporte.total_pagado_anual)}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Deuda Pendiente:</span>
                            <strong class="text-danger">${formatoMoneda(reporte.total_pendiente_anual)}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Documentos Emitidos:</span>
                            <strong>${reporte.total_documentos}</strong>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6>Distribución por Tipo</h6>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Facturas:</span>
                            <strong>${formatoMoneda(reporte.total_facturas)}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Boletas:</span>
                            <strong>${formatoMoneda(reporte.total_boletas)}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Notas Crédito:</span>
                            <strong class="text-success">${formatoMoneda(reporte.total_notas_credito)}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Notas Débito:</span>
                            <strong class="text-warning">${formatoMoneda(reporte.total_notas_debito)}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h6>Ventas Mensuales - ${anio}</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Mes</th>
                                <th>Facturas</th>
                                <th>Boletas</th>
                                <th>Total Ventas</th>
                                <th>% del Total</th>
                                <th>Tendencia</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    reporte.ventas_mensuales.forEach(venta => {
        const porcentaje = ((venta.total_ventas / reporte.total_facturado_anual) * 100).toFixed(1);
        html += `
            <tr>
                <td><strong>${venta.mes}</strong></td>
                <td>${formatoMoneda(venta.total_facturas)}</td>
                <td>${formatoMoneda(venta.total_boletas)}</td>
                <td><strong>${formatoMoneda(venta.total_ventas)}</strong></td>
                <td>${porcentaje}%</td>
                <td>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar" style="width: ${porcentaje}%"></div>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-grid">
                    <button class="btn btn-success" onclick="exportarReporteAnualExcel(${anio})">
                        <i class="fas fa-file-excel"></i> Exportar Reporte Anual Completo a Excel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    contenedor.innerHTML = html;
}

// Exportar reporte anual a Excel
function exportarReporteAnualExcel(anio) {
    window.open(`/api/exportar-reporte-anual-excel?anio=${anio}`, '_blank');
}

// Funciones de exportación
function exportarVentasExcel() {
    window.open('/api/exportar-ventas-excel', '_blank');
}

function exportarDeudasExcel() {
    window.open('/api/exportar-reporte-deudas-excel', '_blank');
}

function exportarTopClientesExcel() {
    window.open('/api/exportar-top-clientes-excel', '_blank');
}

// Aplicar filtros
function aplicarFiltros() {
    const fechaInicio = document.getElementById('filtroFechaInicio').value;
    const fechaFin = document.getElementById('filtroFechaFin').value;
    const tipoDoc = document.getElementById('filtroTipoDoc').value;
    const estado = document.getElementById('filtroEstado').value;
    
    filtrosActivos = {
        fecha_inicio: fechaInicio,
        fecha_fin: fechaFin,
        tipo_doc: tipoDoc,
        estado: estado
    };
    
    // Recargar todos los reportes con los filtros aplicados
    cargarVentasMensuales();
    cargarReporteDeudas();
    cargarTopClientes();
    cargarResumenActual();
}

// Limpiar filtros
function limpiarFiltros() {
    document.getElementById('formFiltrosReportes').reset();
    filtrosActivos = {};
    
    // Recargar todos los reportes sin filtros
    cargarVentasMensuales();
    cargarReporteDeudas();
    cargarTopClientes();
    cargarResumenActual();
}

// Cargar resumen actual desde API
function cargarResumenActual() {
    let url = '/api/reporte-resumen';
    const params = new URLSearchParams(filtrosActivos).toString();
    if (params) url += '?' + params;
    
    fetch(url)
        .then(response => response.json())
        .then(resumen => {
            document.getElementById('totalFacturado').textContent = formatoMoneda(resumen.total_facturado);
            document.getElementById('totalPagado').textContent = formatoMoneda(resumen.total_pagado);
            document.getElementById('totalPendiente').textContent = formatoMoneda(resumen.total_pendiente);
            document.getElementById('totalNC').textContent = formatoMoneda(resumen.total_nc);
            document.getElementById('totalND').textContent = formatoMoneda(resumen.total_nd);
            
            document.getElementById('countPagados').textContent = resumen.count_pagados || 0;
            document.getElementById('countPendientes').textContent = resumen.count_pendientes || 0;
            document.getElementById('countNC').textContent = resumen.count_nc || 0;
            document.getElementById('countAnulados').textContent = resumen.count_anulados || 0;
        })
        .catch(error => {
            console.error('Error al cargar resumen:', error);
        });
}

// Cargar ventas mensuales
function cargarVentasMensuales() {
    let url = '/api/reporte-ventas-mensual';
    const params = new URLSearchParams(filtrosActivos).toString();
    if (params) url += '?' + params;
    
    fetch(url)
        .then(response => response.json())
        .then(ventas => {
            const tbody = document.getElementById('cuerpoVentasMensuales');
            
            if (!ventas || ventas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay datos de ventas</td></tr>';
                return;
            }
            
            let html = '';
            ventas.forEach(venta => {
                html += `
                    <tr>
                        <td>${venta.mes}</td>
                        <td>
                            ${venta.tipo_doc === 'FAC' ? 
                                '<span class="badge bg-primary">Factura</span>' : 
                                '<span class="badge bg-info">Boleta</span>'
                            }
                        </td>
                        <td>${venta.cantidad}</td>
                        <td>${formatoMoneda(venta.valor_neto)}</td>
                        <td>${formatoMoneda(venta.iva)}</td>
                        <td><strong>${formatoMoneda(venta.total_ventas)}</strong></td>
                        <td>
                            <i class="fas fa-arrow-up text-success" title="Tendencia positiva"></i>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        })
        .catch(error => {
            console.error('Error al cargar ventas mensuales:', error);
        });
}

// Cargar reporte de deudas
function cargarReporteDeudas() {
    let url = '/api/reporte-deudas';
    const params = new URLSearchParams(filtrosActivos).toString();
    if (params) url += '?' + params;
    
    fetch(url)
        .then(response => response.json())
        .then(deudas => {
            const tbody = document.getElementById('cuerpoDeudas');
            
            if (!deudas || deudas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-success">No hay deudas pendientes</td></tr>';
                return;
            }
            
            let html = '';
            let totalGeneral = 0;
            
            deudas.forEach(deuda => {
                const deudaValor = parseFloat(deuda.total_deuda) || 0;
                if (deudaValor > 0) {
                    totalGeneral += deudaValor;
                    html += `
                        <tr>
                            <td>${deuda.razon_social}</td>
                            <td>${deuda.rut}</td>
                            <td>${deuda.cantidad_documentos}</td>
                            <td><strong class="text-danger">${formatoMoneda(deudaValor)}</strong></td>
                            <td>${deuda.dias_promedio || 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="verDetalleCliente('${deuda.rut}', '${deuda.razon_social}')">
                                    <i class="fas fa-eye"></i> Detalle
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });
            
            if (html === '') {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-success">No hay deudas pendientes</td></tr>';
                return;
            }
            
            html += `
                <tr class="table-primary">
                    <td colspan="3" class="text-end"><strong>Total General:</strong></td>
                    <td><strong class="text-danger">${formatoMoneda(totalGeneral)}</strong></td>
                    <td colspan="2"></td>
                </tr>
            `;
            
            tbody.innerHTML = html;
        })
        .catch(error => {
            console.error('Error al cargar reporte de deudas:', error);
        });
}

// Cargar top clientes
function cargarTopClientes() {
    let url = '/api/reporte-top-clientes';
    const params = new URLSearchParams(filtrosActivos).toString();
    if (params) url += '?' + params;
    
    fetch(url)
        .then(response => response.json())
        .then(clientes => {
            const tbody = document.getElementById('cuerpoTopClientes');
            
            if (!clientes || clientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay datos de clientes</td></tr>';
                return;
            }
            
            let html = '';
            clientes.forEach((cliente, index) => {
                const promedio = cliente.total_facturado / cliente.total_documentos;
                const topClass = index === 0 ? 'table-warning' : '';
                html += `
                    <tr class="${topClass}">
                        <td>
                            ${index + 1}
                            ${index === 0 ? '<i class="fas fa-crown text-warning ms-1"></i>' : ''}
                        </td>
                        <td>
                            ${index === 0 ? '<i class="fas fa-crown text-warning"></i> ' : ''}
                            ${cliente.razon_social}
                        </td>
                        <td>${cliente.rut}</td>
                        <td>${cliente.total_documentos}</td>
                        <td><strong>${formatoMoneda(cliente.total_facturado)}</strong></td>
                        <td>${formatoMoneda(promedio)}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        })
        .catch(error => {
            console.error('Error al cargar top clientes:', error);
        });
}

// Ver detalle de cliente
function verDetalleCliente(rut, razonSocial) {
    document.getElementById('nombreClienteModal').textContent = razonSocial;
    
    fetch(`/api/documentos-pendientes-cliente?cliente_rut=${rut}`)
        .then(response => response.json())
        .then(documentos => {
            const contenedor = document.getElementById('detalleDocumentosCliente');
            
            if (!documentos || documentos.length === 0) {
                contenedor.innerHTML = '<div class="alert alert-info">No hay documentos pendientes para este cliente.</div>';
            } else {
                let html = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Número</th>
                                    <th>Fecha Emisión</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Descripción</th>
                                    <th>Total</th>
                                    <th>Días Venc.</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                documentos.forEach(doc => {
                    const fechaVenc = new Date(doc.fecha_vencimiento);
                    const hoy = new Date();
                    const diasVencidos = Math.floor((hoy - fechaVenc) / (1000 * 60 * 60 * 24));
                    
                    html += `
                        <tr>
                            <td>${doc.tipo_doc}</td>
                            <td>${doc.numero_doc}</td>
                            <td>${formatoFecha(doc.fecha_emision)}</td>
                            <td>${formatoFecha(doc.fecha_vencimiento)}</td>
                            <td>${doc.descripcion}</td>
                            <td><strong>${formatoMoneda(doc.valor_total)}</strong></td>
                            <td>
                                <span class="badge ${diasVencidos > 0 ? 'bg-danger' : 'bg-warning'}">
                                    ${diasVencidos > 0 ? `${diasVencidos} días` : 'Al día'}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                contenedor.innerHTML = html;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalDetalleCliente'));
            modal.show();
        })
        .catch(error => {
            console.error('Error al cargar detalle del cliente:', error);
        });
}

// Inicializar la página
document.addEventListener('DOMContentLoaded', function() {
    inicializarSelectAnio();
    cargarResumenActual();
    cargarVentasMensuales();
    cargarReporteDeudas();
    cargarTopClientes();
    
    // Establecer fechas por defecto para filtros
    const today = new Date().toISOString().split('T')[0];
    const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('filtroFechaInicio').value = firstDay;
    document.getElementById('filtroFechaFin').value = today;
});
</script>
{% endblock %}