{% extends "base.html" %}

{% block title %}Gestión de Clientes - TekneTau{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-users"></i> Gestión de Clientes</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCliente">
                <i class="fas fa-plus"></i> Nuevo Cliente
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Lista de Clientes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tablaClientes">
                        <thead>
                            <tr>
                                <th>RUT</th>
                                <th>Razón Social</th>
                                <th>Giro</th>
                                <th>Contacto</th>
                                <th>Fecha Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cliente in clientes %}
                            <tr>
                                <td>{{ cliente.rut }}</td>
                                <td>{{ cliente.razon_social }}</td>
                                <td>{{ cliente.giro or 'No especificado' }}</td>
                                <td>
                                    {% if cliente.telefono or cliente.email %}
                                        <small>
                                            {% if cliente.telefono %}{{ cliente.telefono }}<br>{% endif %}
                                            {% if cliente.email %}{{ cliente.email }}{% endif %}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">Sin contacto</span>
                                    {% endif %}
                                </td>
                                <td>{{ cliente.fecha_creacion[:10] }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editarCliente('{{ cliente.rut }}', '{{ cliente.razon_social }}', '{{ cliente.giro }}', '{{ cliente.direccion }}', '{{ cliente.comuna }}', '{{ cliente.telefono }}', '{{ cliente.email }}')">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalClienteTitulo">Nuevo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCliente">
                    <input type="hidden" id="rut_original" name="rut_original">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rut" class="form-label">RUT *</label>
                            <input type="text" class="form-control" id="rut" name="rut" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="razon_social" class="form-label">Razón Social *</label>
                            <input type="text" class="form-control" id="razon_social" name="razon_social" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="giro" class="form-label">Giro</label>
                            <input type="text" class="form-control" id="giro" name="giro">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="comuna" class="form-label">Comuna</label>
                            <input type="text" class="form-control" id="comuna" name="comuna">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="direccion" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="direccion" name="direccion">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" id="btnEliminar" onclick="eliminarCliente()" style="display: none;">Eliminar Cliente</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCliente()">Guardar Cliente</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let modoEdicion = false;
const btnEliminar = document.getElementById('btnEliminar');

function editarCliente(rut, razon_social, giro, direccion, comuna, telefono, email) {
    modoEdicion = true;
    document.getElementById('modalClienteTitulo').textContent = 'Editar Cliente';
    
    document.getElementById('rut_original').value = rut;
    document.getElementById('rut').value = rut;
    document.getElementById('razon_social').value = razon_social;
    document.getElementById('giro').value = giro || '';
    document.getElementById('direccion').value = direccion || '';
    document.getElementById('comuna').value = comuna || '';
    document.getElementById('telefono').value = telefono || '';
    document.getElementById('email').value = email || '';
    
    document.getElementById('rut').readOnly = false; // Permitir edición de RUT
    btnEliminar.style.display = 'block'; // Mostrar botón de eliminar
    
    const modal = new bootstrap.Modal(document.getElementById('modalCliente'));
    modal.show();
}

function guardarCliente() {
    const form = document.getElementById('formCliente');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    let url = '/api/clientes';
    let method = 'POST';

    if (modoEdicion) {
        url = `/api/clientes?rut=${data.rut_original}`;
        method = 'PUT';
    }

    // Validar RUT antes de enviar
    // if (!validarRUT(data.rut)) {
    //     alert('El RUT ingresado no es válido.');
    //     return;
    // }

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message || 'Cliente guardado exitosamente');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Ocurrió un error desconocido.'));
        }
    })
    .catch(error => {
        console.error('Error en fetch:', error);
        alert('Error de conexión con el servidor.');
    });
}

function eliminarCliente() {
    const rut = document.getElementById('rut_original').value;
    if (!rut) {
        alert('No se ha podido identificar al cliente a eliminar.');
        return;
    }

    if (confirm(`¿Estás seguro de que deseas eliminar al cliente con RUT ${rut}? Esta acción no se puede deshacer.`)) {
        fetch(`/api/clientes?rut=${rut}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message || 'Cliente eliminado exitosamente');
                location.reload();
            } else {
                alert('Error al eliminar: ' + (result.error || 'Ocurrió un error desconocido.'));
            }
        })
        .catch(error => {
            console.error('Error en fetch (eliminar):', error);
            alert('Error de conexión con el servidor.');
        });
    }
}

// Resetear modal
$('#modalCliente').on('hidden.bs.modal', function () {
    modoEdicion = false;
    document.getElementById('formCliente').reset();
    document.getElementById('modalClienteTitulo').textContent = 'Nuevo Cliente';
    document.getElementById('rut').readOnly = false;
    btnEliminar.style.display = 'none'; // Ocultar botón de eliminar
});

// Función para validar RUT
function validarRUT(rutCompleto) {
    if (!rutCompleto) return false;

    // Remover puntos y guiones del RUT
    var rutLimpio = rutCompleto.replace(/\./g, '').replace('-', '');

    // Separar número y dígito verificador
    var cuerpo = rutLimpio.slice(0, -1);
    var dv = rutLimpio.slice(-1).toLowerCase();

    // Validar formato (solo números en el cuerpo y 'k' o número en el DV)
    if (!/^\d+$/.test(cuerpo)) return false;

    // Calcular dígito verificador esperado
    var suma = 0;
    var multiplo = 2;

    for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma = suma + parseInt(cuerpo.charAt(i)) * multiplo;
        if (multiplo < 7) {
            multiplo++;
        } else {
            multiplo = 2;
        }
    }
    var dvEsperado = 11 - (suma % 11);
    if (dvEsperado == 11) {
        dvEsperado = '0';
    } else if (dvEsperado == 10) {
        dvEsperado = 'k';
    } else {
        dvEsperado = dvEsperado.toString();
    }

    // Comparar con el dígito verificador ingresado
    return dvEsperado == dv;
}

// Función para formatear RUT (opcional, para una presentación uniforme)
function formatarRUT(rutCompleto) {
    if (!rutCompleto) return '';
    rutCompleto = rutCompleto.replace(/\./g, '').replace('-', '');
    if (rutCompleto.length < 2) return rutCompleto;

    var result = rutCompleto.slice(-4, -1) + '-' + rutCompleto.slice(-1);
    for (var i = 4; i < rutCompleto.length; i += 3) {
        result = rutCompleto.slice(-3 - i, -i) + '.' + result;
    }
    return result;
}

// Resetear modal cuando se cierra
</script>
{% endblock %}
