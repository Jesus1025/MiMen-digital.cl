{% extends "superadmin/base_superadmin.html" %}

{% block title %}Gestión de Restaurantes - SuperAdmin{% endblock %}
{% block page_title %}Gestión de Restaurantes{% endblock %}

{% block content %}
<!-- Stats -->
<div class="columns is-multiline" style="margin-bottom: 1.5rem;">
    <div class="column is-3">
        <div class="stat-card">
            <div class="stat-icon bg-purple">
                <i class="fas fa-store"></i>
            </div>
            <div class="stat-info">
                <h3>{{ restaurantes|length }}</h3>
                <p>Total Restaurantes</p>
            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="stat-card">
            <div class="stat-icon bg-green">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ restaurantes|selectattr('activo', 'equalto', 1)|list|length }}</h3>
                <p>Activos</p>
            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="stat-card">
            <div class="stat-icon bg-orange">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_usuarios }}</h3>
                <p>Usuarios Registrados</p>
            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="stat-card">
            <div class="stat-icon bg-blue">
                <i class="fas fa-calendar-plus"></i>
            </div>
            <div class="stat-info">
                <h3>{{ nuevos_este_mes }}</h3>
                <p>Nuevos este mes</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Restaurantes -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-store" style="color: #8e44ad; margin-right: 0.5rem;"></i>
            Todos los Restaurantes
        </h2>
        <div style="display: flex; gap: 0.5rem;">
            <button class="button is-success" onclick="abrirModalUsuario()">
                <i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i> Crear Usuario
            </button>
            <button class="btn-primary" onclick="abrirModal()">
                <i class="fas fa-plus"></i> Nuevo Restaurante
            </button>
        </div>
    </div>

    <div style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Restaurante</th>
                    <th>URL Slug</th>
                    <th>Estadísticas</th>
                    <th>Estado</th>
                    <th>Fecha Creación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% if restaurantes %}
                    {% for rest in restaurantes %}
                    <tr>
                        <td>#{{ rest.id }}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                {% if rest.logo_url %}
                                    <img src="{{ rest.logo_url }}" alt="{{ rest.nombre }}" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">
                                {% else %}
                                    <div style="width: 40px; height: 40px; background: #ecf0f1; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-store" style="color: #bdc3c7;"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <strong>{{ rest.nombre }}</strong>
                                    {% if rest.rut %}<br><small style="color: #7f8c8d;">RUT: {{ rest.rut }}</small>{% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <a href="/menu/{{ rest.url_slug }}" target="_blank" style="color: #3498db;">
                                /menu/{{ rest.url_slug }}
                                <i class="fas fa-external-link-alt" style="font-size: 0.7rem; margin-left: 0.25rem;"></i>
                            </a>
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.75rem; font-size: 0.85rem;">
                                <span class="tag is-light" title="Categorías">
                                    <i class="fas fa-folder" style="margin-right: 0.3rem;"></i>{{ rest.total_categorias or 0 }}
                                </span>
                                <span class="tag is-light" title="Platos">
                                    <i class="fas fa-utensils" style="margin-right: 0.3rem;"></i>{{ rest.total_platos or 0 }}
                                </span>
                                <span class="tag is-info is-light" title="Visitas">
                                    <i class="fas fa-eye" style="margin-right: 0.3rem;"></i>{{ rest.total_visitas or 0 }}
                                </span>
                            </div>
                        </td>
                        <td>
                            <button class="button is-small {{ 'is-success' if rest.activo else 'is-warning' }}" 
                                    onclick="toggleEstadoRestaurante({{ rest.id }}, {{ rest.activo }})"
                                    title="Click para {{ 'desactivar' if rest.activo else 'activar' }}">
                                <i class="fas {{ 'fa-toggle-on' if rest.activo else 'fa-toggle-off' }}"></i>
                                <span style="margin-left: 0.3rem;">{{ 'Activo' if rest.activo else 'Inactivo' }}</span>
                            </button>
                        </td>
                        <td>{{ rest.fecha_creacion.strftime('%Y-%m-%d') if rest.fecha_creacion else '-' }}</td>
                        <td>
                            <div style="display: flex; gap: 0.25rem;">
                                <button class="button is-small is-info" title="Editar" onclick="editarRestaurante({{ rest.id }}, '{{ rest.nombre }}', '{{ rest.url_slug }}', '{{ rest.rut or '' }}', '{{ rest.logo_url or '' }}', '{{ rest.tema or 'default' }}', {{ rest.activo }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <a href="/menu/{{ rest.url_slug }}" target="_blank" class="button is-small is-success" title="Ver Menú">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="button is-small is-link" title="Ver QR" onclick="verQR('{{ rest.url_slug }}', '{{ rest.nombre }}')">
                                    <i class="fas fa-qrcode"></i>
                                </button>
                                <button class="button is-small is-danger" title="Eliminar" onclick="eliminarRestaurante({{ rest.id }}, '{{ rest.nombre }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 3rem;">
                            <i class="fas fa-store-slash fa-3x" style="color: #bdc3c7; margin-bottom: 1rem;"></i>
                            <p style="color: #7f8c8d;">No hay restaurantes registrados</p>
                            <button class="btn-primary" style="margin-top: 1rem;" onclick="abrirModal()">
                                <i class="fas fa-plus"></i> Agregar primer restaurante
                            </button>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Tabla de Usuarios -->
<div class="dashboard-card" style="margin-top: 2rem;">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-users" style="color: #3498db; margin-right: 0.5rem;"></i>
            Usuarios del Sistema
        </h2>
        <button class="button is-success" onclick="abrirModalUsuario()">
            <i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i> Nuevo Usuario
        </button>
    </div>

    <div style="overflow-x: auto;">
        <table class="data-table" id="tablaUsuarios">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Nombre</th>
                    <th>Restaurante</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="usuariosBody">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Cargando usuarios...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nuevo/Editar Restaurante -->
<div class="modal" id="modalRestaurante">
    <div class="modal-background" onclick="cerrarModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="modalRestauranteTitulo">Nuevo Restaurante</p>
            <button class="delete" onclick="cerrarModal()"></button>
        </header>
        <section class="modal-card-body">
            <form id="formRestaurante">
                <input type="hidden" id="restId">
                
                <div class="field">
                    <label class="label">Nombre del Restaurante *</label>
                    <div class="control">
                        <input class="input" type="text" id="restNombre" required placeholder="Ej: Restaurante El Buen Sabor">
                    </div>
                </div>
                
                <div class="field">
                    <label class="label">URL Slug *</label>
                    <div class="control has-icons-left">
                        <input class="input" type="text" id="restSlug" required placeholder="mi-restaurante" pattern="[a-z0-9-]+">
                        <span class="icon is-small is-left">
                            <i class="fas fa-link"></i>
                        </span>
                    </div>
                    <p class="help">Solo letras minúsculas, números y guiones. Ej: el-buen-sabor</p>
                </div>
                
                <div class="field">
                    <label class="label">RUT</label>
                    <div class="control">
                        <input class="input" type="text" id="restRut" placeholder="12.345.678-9">
                    </div>
                </div>
                
                <div class="field">
                    <label class="label">URL del Logo</label>
                    <div class="control">
                        <input class="input" type="url" id="restLogo" placeholder="https://...">
                    </div>
                </div>
                
                <div class="columns">
                    <div class="column">
                        <div class="field">
                            <label class="label">Tema</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="restTema">
                                        <option value="default">Default (Rojo)</option>
                                        <option value="dark">Oscuro</option>
                                        <option value="elegant">Elegante</option>
                                        <option value="modern">Moderno</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="field">
                            <label class="label">Estado</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="restActivo">
                                        <option value="1">Activo</option>
                                        <option value="0">Inactivo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button" onclick="cerrarModal()">Cancelar</button>
            <button class="button is-primary" onclick="guardarRestaurante()">
                <i class="fas fa-save" style="margin-right: 0.5rem;"></i> Guardar
            </button>
        </footer>
    </div>
</div>

<!-- Modal Nuevo/Editar Usuario -->
<div class="modal" id="modalUsuario">
    <div class="modal-background" onclick="cerrarModalUsuario()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="modalUsuarioTitulo">Crear Usuario para Restaurante</p>
            <button class="delete" onclick="cerrarModalUsuario()"></button>
        </header>
        <section class="modal-card-body">
            <form id="formUsuario">
                <input type="hidden" id="userId">
                
                <div class="field">
                    <label class="label">Restaurante *</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="userRestaurante" required>
                                <option value="">Seleccionar restaurante</option>
                                {% for rest in restaurantes %}
                                    <option value="{{ rest.id }}">{{ rest.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="field">
                    <label class="label">Nombre Completo *</label>
                    <div class="control">
                        <input class="input" type="text" id="userNombre" required placeholder="Ej: Juan Pérez">
                    </div>
                </div>
                
                <div class="field">
                    <label class="label">Usuario (para login) *</label>
                    <div class="control has-icons-left">
                        <input class="input" type="text" id="userUsername" required placeholder="juanperez">
                        <span class="icon is-small is-left">
                            <i class="fas fa-user"></i>
                        </span>
                    </div>
                </div>
                
                <div class="field">
                    <label class="label">Contraseña <span id="passwordHint">*</span></label>
                    <div class="control has-icons-left">
                        <input class="input" type="password" id="userPassword" placeholder="Mínimo 6 caracteres">
                        <span class="icon is-small is-left">
                            <i class="fas fa-lock"></i>
                        </span>
                    </div>
                    <p class="help" id="passwordHelp">Mínimo 6 caracteres</p>
                </div>
                
                <div class="field">
                    <label class="label">Email *</label>
                    <div class="control has-icons-left">
                        <input class="input" type="email" id="userEmail" required placeholder="usuario@ejemplo.com">
                        <span class="icon is-small is-left">
                            <i class="fas fa-envelope"></i>
                        </span>
                    </div>
                    <p class="help">Para contactar al usuario</p>
                </div>
                
                <div class="columns">
                    <div class="column">
                        <div class="field">
                            <label class="label">Rol</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="userRol">
                                        <option value="admin">Administrador (puede editar todo)</option>
                                        <option value="editor">Editor (puede editar menú)</option>
                                        <option value="consulta">Solo Consulta (solo ver)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="column" id="estadoUsuarioColumn" style="display: none;">
                        <div class="field">
                            <label class="label">Estado</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="userActivo">
                                        <option value="1">Activo</option>
                                        <option value="0">Inactivo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button" onclick="cerrarModalUsuario()">Cancelar</button>
            <button class="button is-success" onclick="guardarUsuario()">
                <i class="fas fa-save" style="margin-right: 0.5rem;"></i> <span id="btnGuardarUsuarioTexto">Crear Usuario</span>
            </button>
        </footer>
    </div>
</div>

<!-- Modal QR -->
<div class="modal" id="modalQR">
    <div class="modal-background" onclick="cerrarModalQR()"></div>
    <div class="modal-card" style="max-width: 400px;">
        <header class="modal-card-head">
            <p class="modal-card-title" id="modalQRTitulo">Código QR</p>
            <button class="delete" onclick="cerrarModalQR()"></button>
        </header>
        <section class="modal-card-body" style="text-align: center;">
            <img id="qrImage" src="" alt="QR Code" style="max-width: 280px; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
            <p id="qrUrl" style="margin-top: 1rem; font-size: 0.85rem; color: #666; word-break: break-all;"></p>
        </section>
        <footer class="modal-card-foot" style="justify-content: center;">
            <a id="qrDownload" href="#" download class="button is-primary">
                <i class="fas fa-download" style="margin-right: 0.5rem;"></i> Descargar QR
            </a>
        </footer>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let editandoRestaurante = false;
    let editandoUsuario = false;
    
    // Auto-generar slug desde nombre (solo si no estamos editando)
    document.getElementById('restNombre').addEventListener('input', function() {
        if (editandoRestaurante) return;
        const nombre = this.value;
        const slug = nombre
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        document.getElementById('restSlug').value = slug;
    });

    // ========== RESTAURANTES ==========
    
    function abrirModal() {
        editandoRestaurante = false;
        document.getElementById('modalRestauranteTitulo').textContent = 'Nuevo Restaurante';
        document.getElementById('restId').value = '';
        document.getElementById('formRestaurante').reset();
        document.getElementById('restActivo').value = '1';
        document.getElementById('modalRestaurante').classList.add('is-active');
    }
    
    function editarRestaurante(id, nombre, slug, rut, logo, tema, activo) {
        editandoRestaurante = true;
        document.getElementById('modalRestauranteTitulo').textContent = 'Editar Restaurante';
        document.getElementById('restId').value = id;
        document.getElementById('restNombre').value = nombre;
        document.getElementById('restSlug').value = slug;
        document.getElementById('restRut').value = rut;
        document.getElementById('restLogo').value = logo;
        document.getElementById('restTema').value = tema;
        document.getElementById('restActivo').value = activo ? '1' : '0';
        document.getElementById('modalRestaurante').classList.add('is-active');
    }

    function cerrarModal() {
        document.getElementById('modalRestaurante').classList.remove('is-active');
        document.getElementById('formRestaurante').reset();
        editandoRestaurante = false;
    }

    async function guardarRestaurante() {
        const id = document.getElementById('restId').value;
        const data = {
            nombre: document.getElementById('restNombre').value,
            url_slug: document.getElementById('restSlug').value,
            rut: document.getElementById('restRut').value,
            logo_url: document.getElementById('restLogo').value,
            tema: document.getElementById('restTema').value,
            activo: parseInt(document.getElementById('restActivo').value)
        };

        if (!data.nombre || !data.url_slug) {
            alert('Nombre y URL Slug son obligatorios');
            return;
        }

        try {
            const url = id ? `/api/restaurantes/${id}` : '/api/restaurantes';
            const method = id ? 'PUT' : 'POST';
            
            const res = await fetchWithCSRF(url, {
                method: method,
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            
            if (result.success) {
                cerrarModal();
                location.reload();
            } else {
                alert(result.error || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }
    
    async function toggleEstadoRestaurante(id, estadoActual) {
        const nuevoEstado = estadoActual ? 0 : 1;
        const accion = nuevoEstado ? 'activar' : 'desactivar';
        
        if (!confirm(`¿Estás seguro de ${accion} este restaurante?`)) {
            return;
        }
        
        try {
            // Primero obtenemos los datos actuales
            const resGet = await fetch(`/api/restaurantes/${id}`);
            const restData = await resGet.json();
            
            // Actualizamos solo el estado
            restData.activo = nuevoEstado;
            
            const res = await fetchWithCSRF(`/api/restaurantes/${id}`, {
                method: 'PUT',
                body: JSON.stringify(restData)
            });
            
            const result = await res.json();
            
            if (result.success) {
                location.reload();
            } else {
                alert(result.error || 'Error al cambiar estado');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }
    
    async function eliminarRestaurante(id, nombre) {
        if (!confirm(`¿Estás seguro de eliminar "${nombre}"?\n\nEsto eliminará también todos los usuarios, categorías y platos asociados.`)) {
            return;
        }
        
        try {
            const res = await fetchWithCSRF(`/api/restaurantes/${id}`, {
                method: 'DELETE'
            });
            
            const result = await res.json();
            
            if (result.success) {
                location.reload();
            } else {
                alert(result.error || 'Error al eliminar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }

    // ========== QR ==========
    
    function verQR(slug, nombre) {
        const baseUrl = window.location.origin;
        const menuUrl = `${baseUrl}/menu/${slug}`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(menuUrl)}`;
        
        document.getElementById('modalQRTitulo').textContent = `QR - ${nombre}`;
        document.getElementById('qrImage').src = qrUrl;
        document.getElementById('qrUrl').textContent = menuUrl;
        document.getElementById('qrDownload').href = qrUrl;
        document.getElementById('qrDownload').download = `QR_${slug}.png`;
        document.getElementById('modalQR').classList.add('is-active');
    }
    
    function cerrarModalQR() {
        document.getElementById('modalQR').classList.remove('is-active');
    }

    // ========== USUARIOS ==========
    
    document.addEventListener('DOMContentLoaded', cargarUsuarios);
    
    async function cargarUsuarios() {
        try {
            const res = await fetch('/api/usuarios');
            const usuarios = await res.json();
            renderizarUsuarios(usuarios);
        } catch (error) {
            console.error('Error cargando usuarios:', error);
            document.getElementById('usuariosBody').innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle"></i> Error al cargar usuarios
                    </td>
                </tr>
            `;
        }
    }
    
    function renderizarUsuarios(usuarios) {
        const tbody = document.getElementById('usuariosBody');
        
        if (usuarios.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                        <i class="fas fa-users-slash" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><br>
                        No hay usuarios registrados
                    </td>
                </tr>
            `;
            return;
        }
        
        const rolColors = {
            'superadmin': 'is-danger',
            'admin': 'is-primary',
            'editor': 'is-info',
            'consulta': 'is-light'
        };
        
        const rolIcons = {
            'superadmin': 'fa-crown',
            'admin': 'fa-user-shield',
            'editor': 'fa-user-edit',
            'consulta': 'fa-user'
        };
        
        tbody.innerHTML = usuarios.map(user => `
            <tr>
                <td>#${user.id}</td>
                <td><strong>${user.username}</strong></td>
                <td>${user.nombre || '-'}</td>
                <td>${user.restaurante_nombre || '<span class="tag is-dark"><i class="fas fa-crown" style="margin-right: 0.3rem;"></i>SuperAdmin</span>'}</td>
                <td>
                    <span class="tag ${rolColors[user.rol] || 'is-light'}">
                        <i class="fas ${rolIcons[user.rol] || 'fa-user'}" style="margin-right: 0.3rem;"></i>
                        ${user.rol}
                    </span>
                </td>
                <td>
                    ${user.username !== 'superadmin' ? `
                        <button class="button is-small ${user.activo ? 'is-success' : 'is-warning'}" 
                                onclick="toggleEstadoUsuario(${user.id}, ${user.activo})"
                                title="Click para ${user.activo ? 'desactivar' : 'activar'}">
                            <i class="fas ${user.activo ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                            <span style="margin-left: 0.3rem;">${user.activo ? 'Activo' : 'Inactivo'}</span>
                        </button>
                    ` : `<span class="tag is-success">Activo</span>`}
                </td>
                <td>
                    ${user.username !== 'superadmin' ? `
                        <div style="display: flex; gap: 0.25rem;">
                            <button class="button is-small is-info" onclick="editarUsuario(${user.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="button is-small is-warning" onclick="resetPassword(${user.id}, '${user.username}')" title="Resetear contraseña">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="button is-small is-danger" onclick="eliminarUsuario(${user.id}, '${user.username}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    ` : '<span class="tag is-light">Protegido</span>'}
                </td>
            </tr>
        `).join('');
    }
    
    async function toggleEstadoUsuario(id, estadoActual) {
        const nuevoEstado = estadoActual ? 0 : 1;
        const accion = nuevoEstado ? 'activar' : 'desactivar';
        
        if (!confirm(`¿Estás seguro de ${accion} este usuario?`)) {
            return;
        }
        
        try {
            const resGet = await fetch(`/api/usuarios/${id}`);
            const userData = await resGet.json();
            
            userData.activo = nuevoEstado;
            
            const res = await fetchWithCSRF(`/api/usuarios/${id}`, {
                method: 'PUT',
                body: JSON.stringify(userData)
            });
            
            const result = await res.json();
            
            if (result.success) {
                cargarUsuarios();
            } else {
                alert(result.error || 'Error al cambiar estado');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }
    
    async function editarUsuario(id) {
        try {
            const res = await fetch(`/api/usuarios/${id}`);
            const user = await res.json();
            
            editandoUsuario = true;
            document.getElementById('modalUsuarioTitulo').textContent = 'Editar Usuario';
            document.getElementById('btnGuardarUsuarioTexto').textContent = 'Guardar Cambios';
            document.getElementById('userId').value = user.id;
            document.getElementById('userRestaurante').value = user.restaurante_id || '';
            document.getElementById('userNombre').value = user.nombre || '';
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').removeAttribute('required');
            document.getElementById('passwordHint').textContent = '(dejar vacío para mantener)';
            document.getElementById('passwordHelp').textContent = 'Dejar vacío para mantener la contraseña actual';
            document.getElementById('userRol').value = user.rol || 'admin';
            document.getElementById('userActivo').value = user.activo ? '1' : '0';
            document.getElementById('estadoUsuarioColumn').style.display = 'block';
            
            document.getElementById('modalUsuario').classList.add('is-active');
        } catch (error) {
            console.error('Error:', error);
            alert('Error al cargar datos del usuario');
        }
    }
    
    async function resetPassword(id, username) {
        const nuevaPassword = prompt(`Nueva contraseña para "${username}":\n(Mínimo 6 caracteres)`);
        
        if (!nuevaPassword) return;
        
        if (nuevaPassword.length < 6) {
            alert('La contraseña debe tener al menos 6 caracteres');
            return;
        }
        
        try {
            const resGet = await fetch(`/api/usuarios/${id}`);
            const userData = await resGet.json();
            
            userData.password = nuevaPassword;
            
            const res = await fetchWithCSRF(`/api/usuarios/${id}`, {
                method: 'PUT',
                body: JSON.stringify(userData)
            });
            
            const result = await res.json();
            
            if (result.success) {
                alert(`✓ Contraseña actualizada exitosamente!\n\nUsuario: ${username}\nNueva contraseña: ${nuevaPassword}`);
            } else {
                alert(result.error || 'Error al actualizar contraseña');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }
    
    async function eliminarUsuario(id, username) {
        if (!confirm(`¿Estás seguro de eliminar al usuario "${username}"?`)) {
            return;
        }
        
        try {
            const res = await fetchWithCSRF(`/api/usuarios/${id}`, {
                method: 'DELETE'
            });
            
            const result = await res.json();
            
            if (result.success) {
                cargarUsuarios();
            } else {
                alert(result.error || 'Error al eliminar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }

    // Modal Usuario
    function abrirModalUsuario() {
        editandoUsuario = false;
        document.getElementById('modalUsuarioTitulo').textContent = 'Crear Usuario para Restaurante';
        document.getElementById('btnGuardarUsuarioTexto').textContent = 'Crear Usuario';
        document.getElementById('userId').value = '';
        document.getElementById('formUsuario').reset();
        document.getElementById('userPassword').setAttribute('required', 'required');
        document.getElementById('passwordHint').textContent = '*';
        document.getElementById('passwordHelp').textContent = 'Mínimo 6 caracteres';
        document.getElementById('estadoUsuarioColumn').style.display = 'none';
        document.getElementById('modalUsuario').classList.add('is-active');
    }

    function cerrarModalUsuario() {
        document.getElementById('modalUsuario').classList.remove('is-active');
        document.getElementById('formUsuario').reset();
        editandoUsuario = false;
    }

    async function guardarUsuario() {
        const id = document.getElementById('userId').value;
        const data = {
            restaurante_id: parseInt(document.getElementById('userRestaurante').value) || null,
            nombre: document.getElementById('userNombre').value,
            username: document.getElementById('userUsername').value,
            password: document.getElementById('userPassword').value,
            email: document.getElementById('userEmail').value.trim(),
            rol: document.getElementById('userRol').value,
            activo: parseInt(document.getElementById('userActivo')?.value || 1)
        };

        if (!data.nombre || !data.username) {
            alert('Nombre y usuario son obligatorios');
            return;
        }
        
        if (!data.email || !data.email.includes('@')) {
            alert('El email es obligatorio y debe ser válido');
            return;
        }
        
        if (!data.restaurante_id) {
            alert('Debes seleccionar un restaurante');
            return;
        }

        // Si es nuevo usuario, la contraseña es obligatoria
        if (!id && !data.password) {
            alert('La contraseña es obligatoria para nuevos usuarios');
            return;
        }

        if (data.password && data.password.length < 6) {
            alert('La contraseña debe tener al menos 6 caracteres');
            return;
        }
        
        // Si no hay password y es edición, no la enviamos
        if (!data.password && id) {
            delete data.password;
        }

        try {
            const url = id ? `/api/usuarios/${id}` : '/api/usuarios';
            const method = id ? 'PUT' : 'POST';
            
            const res = await fetchWithCSRF(url, {
                method: method,
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            
            if (result.success) {
                if (!id) {
                    alert('✓ Usuario creado exitosamente!\n\nUsuario: ' + data.username + '\nContraseña: ' + data.password);
                }
                cerrarModalUsuario();
                cargarUsuarios();
            } else {
                alert(result.error || 'Error al guardar usuario');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    }
</script>
{% endblock %}
